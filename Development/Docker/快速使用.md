## 快速使用 docker

### 安装配置及卸载

#### 基于 ubuntu 安装

```shell
# 删除旧版本
sudo apt remove docker docker-engine docker.io
# 安装依赖
sudo apt install apt-transport-https ca-certificates curl gnupg2 software-properties-common
# 信任 GPG 公钥
curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo apt-key add -
# 使用 mirror
sudo add-apt-repository \
	"deb [arch=amd64] https://mirrors.tuna.tsinghua.edu.cn/docker-ce/linux/ubuntu \
	stable"
# 安装 docker-ce
sudo apt update
sudo apt install docker-ce
# 添加用户到 docker 组
sudo usermod -aG docker your-user
# 配置 daemon
sudo systemctl enable docker
# 卸载
sudo apt purge docker-ce
```

#### 配置

##### 允许接受来自远程主机登录

默认情况下，Docker 守护程序监听 unix 套接字上的连接以接受来自本地客户端的请求。通过将 `docker` 配置为监听 IP 地址以及 Unix 套接字，可以允许 `Docker` 接受来自远程主机的请求。可以使用 `docker.service` 或 `daemon.json`，但是不能两个一起使用

* `docker.service`

  ```shell
  # 编辑
  sudo systemctl edit docker.service
  # 添加或修改
  [Service]
  ExecStart=
  ExecStart=/usr/bin/dockerd -H fd:// -H tcp://127.0.0.1:2375
  # 重载
  systemctl daemon-reload
  # 重启
  sudo systemctl restart docker.service
  ```

* `daemon.json`

  ```shell
  # /etc/docker/daemon.json
  {
      "hosts": ["unix:///var/run/docker.sock", "tcp://127.0.0.1:2375"]
  }
  # 重启
  sudo systemctl restart docker.service
  ```

### 镜像

#### 常用操作

```shell
# 拉取镜像
docker pull NAME[:TAG]
# 列出镜像
docker images
# 查看镜像详情
docker inspect ubuntu:18.04
docker inspcet -f {{'.Architecture'}} ubuntu:18.04
# 查看镜像历史
docker history ubuntu:18.04
# 使用 tag 命令添加镜像标签
docker tag ubuntu:latest myubunut:latest
# 搜索镜像
docker search [option] keyword
-f, --filter 过滤输出内容
--format string: 格式化输出内容
--limit int 限制输出个数
--no-trunc 不解读按输出结果
docker search --filter=is-official=true nginx
# 删除镜像
docker rmi IMAGE[IMAGE...]/docker image rm
-f, -force 强制删除，即使有容器依赖
--no-prune 不要清理未带标签的父镜像
# 清理镜像
docker image prune [option]
-a, -all: 删除所有无用镜像，不光是临时镜像
-filter filter: 只清理符合给定过滤器的镜像
-f, -force: 强制删除镜像
```

#### 创建镜像

##### 基于已有容器创建

命令 docker [container] commit

`docker [container] commit [OPTIONS] CONTAINER[REPSOTPRY][:TAG]`

-a, --author=“”：作者信息

-c, --change=[]: 提交时执行的 dockerfile 指令，包含 `CMD|ENTRYPOINT|ENV|EXPOSE|LABEL|ONBUILD|USER|VOLUME|WORKDIR`

-m, --message="": 提交信息

-p, --pause=true: 提交时暂停容器运行

##### 基于本地模板导入

可以直接从一个操作系统模板文件导入一个镜像，使用 `docker[container]import`，`docker[image]import[options]file|url|-[repository[:tag]`

`cat ubuntu-18.04-x86_64-minimal.tar.gz | docker import - ubuntu:18.04`

##### 基于 Dockerfile

Dockerfile 使用级别的 DSL 域名指令来构建一个 Docker 进行，在初始目录里创建 Dockerfile 文件，这个目录就是构建环境，docker 以此作为构建上下文，docker 会在构建镜像时将构建上下文和该上下文中的文件目录上传到 docker 守护进程，Dockerfile 由一系列指令和参数组成，指令必须大写，指令会从上到下顺序执行，每条指令都会创建一个新的镜像层并对镜像进行提交

一般，Dockerfile 主体内容分为：基础镜像信息，维护者信息，镜像操作和容器启动时执行指令。首行可以用注释来指导解析命令，后续通过注释说明镜像的相关信息。主题不符首先使用 FROM 指令指明所基于的镜像名称，后面则是镜像操作指令，最后时 CMD 指令，来指定运行容器时的操作指令

