## 使用检查点将虚拟机恢复到以前的状态

### 概述

虚拟化的最大优势是能够轻松地保存虚拟机的状态。在 `Hyper-V` 中，通过使用虚拟机检查点完成此操作。可以先创建虚拟机检查点，然后进行软件配置更改、应用软件更新或安装新的软件。如果系统更改导致问题，可以将虚拟机恢复为创建检查点时其所处的状态

`Windows 10 Hyper-V` 包括两种类型的检查点：

* **标准检查点**：的启动检查点时，获取虚拟机和虚拟机内存状态的快照。快照并非完整备份，并可能导致系统在 `Active Directory` 等不同节点之间复制数据时出现数据一致性。`Hyper-V` 只提供 `Windows 10` 之前的标准检查点（以前称为快照）
* **生产检查点：**使用卷影复制服务或文件系统冻结 `Linux` 虚拟机上创建虚拟机的数据一致性备份。没有获取任何虚拟机内存状态的快照

默认情况下选择“生产检查点”，但可以使用 `Hyper-V` 管理器或 `PowerShell` 对该选择进行更改

### 更改检查点类型

#### 使用 `Hyper-V` 管理器

1.打开 `Hyper-V` 管理器

2.右键单击虚拟机，然后选择设置

3.在“管理”下，选择检查点

4.选择所需的检查点类型

#### 使用 `PowerShell`

可以运行以下命令来使用 `PowerShell` 更改检查点

* 设置为标准检查点

  ```powershell
  Set-VM -Name <vmname> -CheckpointType Standard
  ```

* 设置为生产检查点（如果生产检查点失败，则创建标准检查点）

  ```powershell
  Set-VM -Name <vmname> -CheckpointType Production
  ```

* 设置为生产检查点（如果生产检查点失败，则不创建标准检查点）

  ```powershell
  Set-VM -Name <vmname> -CheckpointType ProductionOnly
  ```

### 创建检查点

创建为虚拟机配置的类型的检查点

#### 使用 Hyper-V 管理器

1.在 `Hyper-V` 管理器中，选择虚拟机

2.右键单击虚拟机的名称，然后单击检查点

3.当此过程完成时，检查点将 `Hyper-V` 管理器中的检查点下显示

#### 使用 PowerShell

使用 `CheckPoint-Vm` 命令创建检查点

```powershell
Checkpoint-VM -Name <VMName>
```

### 应用检查点

可以将虚拟机恢复到以前的时间点，可以应用现有检查点

#### 使用 Hyper-V 管理器

1.在 `Hyper-V` 管理器中的虚拟机下，选择虚拟机

2.在 "检查点" 部分中，右键单击想要使用的检查点， 然后单击应用

3.将显示一个带由以下选项的对话框

* 创建检查点并应用：在虚拟机应用以前的检查点之前创建新的检查点
* 应用：仅应用已选择的检查点。不能撤销此操作
* 取消：在不执行任何操作的情况下，关闭该对话

####  使用 PowerShell

* 查看虚拟机的检查点列表

  ```powershell
  Get-VMCheckpoint -VMName <VMName>
  ```

* 若要应用检查点，请使用 `Restore-VMCheckpoint` 命令

  ```powershell
  Resotre-VMCheckpoint -Name <checkpoint name> -VMName <VMName> -Confirm:$false
  ```

### 重命名检查点

在某个特定点上创建多个检查点，通过为其提供可识别名称易于创建检查点时记住有关系统状态的详细信息

默认情况下，检查点的名称是虚拟机       

```powershell
virtual_machine_name (MM/DD/YYY -hh:mm:ss AM\PM)
```

#### 使用 Hyper-V 管理器

1.选择虚拟机

2.单击检查点选择重命名

3.输入新名称（小于 100 个字符，并且该字段不能为空）

4.完成

#### 使用 `powershell`

```powershell
Rename-VMCheckpoint -VMName <virtual machine name> -Name <checkpoint name> -NewName <new checkpoint name>
```

### 删除检查点

#### 使用 powershell

```powershell
Remove-VMCheckpoint -VMName <virtual machine name> -Name <checkpoint name>
```

### 导出检查点

导出会将检查点捆绑为虚拟机，以便检查点可以移动到新的位置。导入后，检查点将还原为虚拟机。导出的检查点可用于备份

```powershell
Export-VMCheckpoint -VMName <virtual machine name> -Name <checkpoint name> -Path <path for export>
```

### 配置检查点位置

如果虚拟机没有检查点，可以更改检查点配置和已保存状态文件的存储位置

用于存储检查点配置文件的默认位置是：

```powershell
%systemroot%\ProgramData\Microsoft\Windows\Hyper-V\Snapshots
```

1.可在 Hyper-V 管理器中，右键单击虚拟机的名称，单击设置

2.在管理部分，选择检查点或检查点文件位置，

3.在检查点文件位置中，输入希望存储文件的文件夹路径

4.单击应用以应用更改

