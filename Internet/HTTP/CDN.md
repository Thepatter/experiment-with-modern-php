### CDN

#### Content Delivery Network

外部加速 HTTP 协议的服务。CDN 的核心原则是“就近访问”。主要适用缓存代理技术，使用“推”或“拉”的手段，把源站的内容逐级缓存到网络的每一个节点上。用户在上网的时候就不直接访问源站，而是访问离他最近的一个 CDN 节点（边缘节点）即缓存了源站内容的代理服务器。

在 CDN 领域里，“内容”即 HTTP 协议的“资源”，比如超文本、图片、视频、应用程序安装包。资源按照是否可缓存分为“静态资源”和“动态资源”。“静态资源”是指数据内容“静态不变”，任何时候来访问都是一样的，如图片、音频。“动态资源”即数据内容是由服务器实时计算生成的。每次访问不一样。只有静态资源才能被缓存加速、就近访问，而动态资源只能由源站实时生成，即使缓存了也没有意义。不过，如果动态资源指定了`Cache-Control`，允许缓存短暂的时候，那它在这段时间里就变成了“静态资源”，可以被 CDN 缓存加速

#### CDN 负载均衡

CDN 有两个关键组成部分：**全局负载均衡**和**缓存系统**，对应的是 DNS 和缓存代理技术。

全局负载均衡（Global Server Load Balance）GSLB，它是 CDN 的大脑，主要职责是当用户接入网络的时候在 CDN 专网中挑选出一个最佳节点提供服务，解决的是用户如何找到最近的边缘节点，对整个 CDN 网络进行“负载均衡”。

GSLB 最常见的实现方式是 “DNS负载均衡”，原来没有 CDN 的时候，权威 DNS 返回的是网站自己服务器的实际 IP 地址，浏览器收到 DNS 解析结果后直连网站。但加入 CDN 后，权威 DNS 返回的不是 IP 地址，而是一个 CNAME（Canonical Name）别名记录，指向的就是 CDN 的 GSLB。因为没能获取 IP 地址，于是本地 DNS 就会向 GSLB 再发起请求，这样就进入了 CDN 的全局负载均衡系统，开始调度，依据：

* 看用户的 IP 地址，查表得到地理位置，找相对最近的边缘节点
* 看用户所在的运营商网络，找相同网络的边缘节点
* 检查边缘节点的负载情况，找负载较轻的节点
* 检查节点的服务能力，带宽，响应时间等

GSLB 会根据这些因素，用算法，找出一个最合适的边缘节点。把这个节点的 IP 地址返回给用户，用户就可以就近访问 CDN 的缓存代理

#### CDN 缓存代理

缓存系统是 CDN 的另一个关键组成部分，衡量 CDN 服务质量的指标：“命中率”和“回源率”

* 命中

  指用户访问的资源恰好在缓存系统里，可以直接返回给用户

* 回源

  缓存里没有，必须使用代理的方式回源站取

