## Internet 地址结构

### 概述

连接到 `Internet` 的每个设备至少有一个 IP 地址。基于 `TCP/IP` 协议的专用网络中使用的设备也需要 IP 地址。在任何情况下，IP 路由器实现的转发程序使用 IP 地址来识别流量去向。IP 地址也表示流量的来源

### 表示 IP 地址

#### `IPv4`地址

这些地址通常采用点分四组或点分十进制表示法，每个数字是一个非负整数，范围为 `0~255`，代表整个 IP 地址的四分之一。点分四组表示法是编写完整的 IPv4 地址（32 位非负整数）的简单方式，它使用便捷的十进制数

#### `IPv6` 地址

在 IPv6 中，地址的长度是 128 位，是 IPv4 地址长度的 4 倍。IPv6 地址的传统表示法是采用称为块或字段的四个十六进制数，这些块由冒号分隔。一些已取得共识的 IPv6 地址简化表示法已被标准化（RFC4291）：

* 一个块中前导的零不必书写
* 全零的块可以省略
* 在 IPv6 格式中嵌入 IPv4 地址可使用混合符号形式，紧接着 IPv4 部分的地址块的值为 `ffff`，地址的其余部分使用点分四组格式。如 `IPv6` 地址 `::ffff:10.0.0.1` 表示 IPv4 地址 `10.0.0.1`。它被称为 IPv4 映射的 IPv6 地址
* IPv6 地址的低 32 位通常采用点分四组表示法。因此，IPv6 地址 `::0102:f001` 相当于地址 `::1.2.240.1`。它被称为 IPv4 兼容的 IPv6 地址。IPv4 兼容地址与 IPv4 映射地址不同；它们只是能用类似 IPv4 地址的方式书写或由软件处理方面给人以兼容的感觉。这种地址最初用于 IPv4 和 IPv6 之间的过渡计划，但现在不再需要
* 在某些情况下（如表示一个包含地址的 URL 时），IPv6 地址中的冒号分隔符可能与其他分隔符混淆，在这种情况下，用括号字符 `[]` 包围 IPv6 地址。如 `http://[2001:0db8:85a3:1319:8a2e:0370:7344]:443/`

`[RFC4291]` 提供的灵活性造成了不必要的混淆，因为能用多种方式表示相同的 IPv6 地址。`[RFC5952]` 制定了一些规则，以缩小选择范围，同时与 `[RFC4291]` 保持兼容：

* 前导的零必须压缩（如：，`2001:0db8::0022` 变成 `2001:db8::22`）
* `::` 只能用于影响最大的地方（压缩最多的零），但并不只是针对 16 位的块。如果多个块中包含等长度的零，顺序靠前的块将被替换为 `::`
* `a~f` 的十六进制数用小写表示

### 基本的 IP 地址结构

IPv4 地址空间中有 `4294967296` 个可能的地址，而 IPv6 的地址个数为 `2^128` 个地址。由于拥有大量地址，可以方便地将地址空间划分成块，IP 地址可根据类型和大小分组。大多数 IPv4 地址块最终被细分为一个地址，用于识别连接 `Interenet` 或某些专用的内联网的计算机网络接口。这些地址称为**单播地址**，其他类型的地址包括广播、组播和任播地址，它们可能涉及多个接口，还有一些特殊用途的地址。

#### 分类寻址

当最初定义 `Internet` 地址结构时，每个单播 IP 地址都有一个网络部分，用于识别接口使用的 IP 地址在那个网络中可被发现；以及一个主机地址，用于识别由网络部分给出的网络中的特定主机。因此，地址中的一些连续位称为**网络号**，其余位称为**主机号**。当时，大多数主机只有一个网络接口，因为术语接口地址和主机地址有时交替使用

现实中的不同网络可能有不同数量的主机，每台主机都需要一个唯一的 IP 地址。一种划分方法是基于当前或预计的主机数量，将不同大小的 IP 地址空间分配给不同的站点。地址空间的划分涉及五大类。每类都基于网络中可容纳的主机数量，确定在一个 32 位的 IPv4 地址中分配给网络号和主机号的位数

*五类地址*

![](./Images/五类地址.png)

​                                                                                                                                                                                                                                                                                                                                                  IPv4 地址空间最初分为五大类。A、B、C 类用于为  `Internet` (单播地址）中的接口分配地址，以及其他一些特殊情况下使用。IP 地址类型由地址中的头几位来定义：0 为 A 类，10 为 B 类，110 为 C 类，D 类地址供组播使用，E 类地址保留

*分类地址空间划分*

![](./Images/分类地址空间划分.png)

这些数字是不准确的，有几个地址通常不作为单播地址使用。特别是，地址块中的第一个和最后一个地址通常不使用。

#### 子网寻址

Internet 发展初期首先遇到一个困难，那就是很难为接入 `Internet` 的新网段分配一个新的网络号。80 年代后，随着局域网（LAN）的发展和增加，这个问题变得更棘手。为了解决这个问题，人们想到一个方式，在一个站点接入 Internet 后为其分配一个网络号，然后由站点管理员进一步划分本地的子网数。在不改变 Internet 核心路由基础设施的情况下解决这个问题。

实现这个想法需要改变一个 IP 地址的网络部分和主机部分的限制，但这样做只是针对一个站点自身而言；Internet 其余部分将只能“看到"传统的 A 类、B 类、C 类部分。支持此功能的方法称为**子网寻址**。通过子网寻址，一个站点被分配一个 A，B，C 类的网络号，保留一些剩余主机号进一步用于站点内分配。该站点可能将基础地址中的主机部分进一步划分为一个子网号和一个主机号。从本质上来说，子网寻址为 IP 地址结构增加了一个额外部分，但它没有为地址增加长度。因此，一个站点管理员能在子网数和每个子网中预期的主机数之间折中，同时不需要与其他站点协调

子网寻址提供额外灵活性的代价是增加成本。由于当前的子网字段和主机字段的定义是由站点指定的（不是由网络号分类决定），一个站点中所有路由器和主机需要一种新的方式，以确定地址中的子网部分和其他的主机部分。在出现子网之前，这个信息可直接从一个网络号中获得，只需知道是 A 类、B 类 或 C 类地址（由地址的前几位表示）

*B类地址划分子网*

![](./Images/B类地址划分子网.png)

一个B类地址被划分子网，它使用 8 位作为子网 ID，提供 256 个子网和每个子网中 254 台主机（当前每个子网的第一个和最后一个地址无效，即从整个分配范围中除去第一个和最后一个地址），这种划分可由网络管理员改变。该站点将每个地址的前 16 位固定为某些特定号码，这是由于这些位已被分配给核心机构。后 16 位（仅用于在无子网的 B 类网络中创建主机号）限制可以由站点的网络管理员按需分配。只有划分子网的网络中的主机和路由器知道子网结构。在需要进行子网寻址之前，Internet 其他部分仍将它作为站点相关的地址来看待。

*子网掩码工作*

![](./Images/子网掩码工作.png)

某个站点被分配一个典型的 B 类网路号 128.32。网络管理员决定用于站点范围内的子网掩码为 `255.255.255.0`，提供 256 个子网，每个子网可容纳 256 - 2 = 254 台主机。同一子网中每台主机的 IPv4 地址拥有相同子网号。左侧的局域网段中主机的 IPv4 地址开始于 `128.32.1，右侧的所有主机开始于 `128.32.2`

在上图中，显示了一个虚拟的站点，使用一个边界路由器（即 `Internet` 的一个连接点）连接 `Internet` 和两个内部局域网。x 的值可以是 `[0, 255]`，范围内的任意值。每个以太网是一个 IPv4 子网，整体分配为 B 类地址的网络号 `128.32`。Internet 中其他站点要访问这个站点，目的地址以 `128.32` 开始的所有流量直接由 Internet 路由系统交给边界路由器（特别是其接口的 IPv4 地址 137.164.23.30）。在这点上，边界路由器必须区分 `128.32` 网络中的不同子网。特别是，它必须能区分和分离目的地址为 `128.32.1.x` 和目的地址为 `128.32.2.x` 的流量。这些地址分别表示子网号 1 和 2，它们都采用 `128.32` 的 B 类网路号。为了做到这点，路由器必须知道在地址中如何找到子网 ID。这可通过一个配置参数实现。

#### 子网掩码

子网掩码是由**一台主机或路由器使用的分配位，以确定如何从一台主机对应 IP 地址中获得网络和子网信息**。IP 子网掩码与对应的 IP 地址长度相同（IPv4 为 32 位，IPv6 为 128 位）它们通常在一台主机或路由器中以 IP 地址相同的方式配置，既可以是静态的（通常是路由器），也可以使用动态配置（动态主机配置协议（DHCP））。对于 IPv4 ，子网掩码以 IPv4 地址相同的方式（点分十进制）编写。当前子网掩码由一些 1 后跟一些 0 构成。这样安排，就可以用容易记的格式表示掩码，只需给出一些连续位的 1 （左起）的掩码。这种格式是当前最常见的格式，有时也被称为**前缀长度**

*各种格式的 IPv4 子网掩码的例子*

![](./Images/IPv4子网掩码的例子.png)

*各种格式的 IPv4 子网掩码的例子*

![](./Images/IPv6子网掩码例子.png)

**子网掩码由路由器和主机使用，以确定一个 IP 地址的网络/子网部分的结束和主机部分的开始。子网掩码中的一位设为 1 表示一个 IP 地址的对应位与一个地址的网络/子网部分对应位相结合，并将结果作为转发数据报的基础。相反，子网掩码中的一位设为 0，表示一个 IP 地址的对应位作为主机 ID 的一部分。**

*子网掩码为255.255.255.0 时处理 IPv4 地址 128.32.1.14*

![](./Images/子网掩码处理IPv4.png)

IP 地址中的每位与子网掩码中的对应位进行与运算。**Internet 路由系统其余部分不需要子网掩码的知识，因为站点之外的路由器做出路由决策只基于地址的网络号部分，并不需要网络/子网或主机部分。因此子网掩码纯粹是站点内部的局部问题**

#### 可变长度子网掩码

在同一站点的不同部分，可将不同长度的子网掩码应用于相同的网路号。虽然这样增加了地址配置管理的复杂性，但也提高了子网结构的灵活性，由于不同子网可容纳不同数量的主机。目前，大多数主机、路由器和路由协议支持可变长度子网掩码（VLSM）。

*可变长度子网掩码*

![](./Images/可变长度子网掩码.png)

三个不同的子网掩码被用于站点中的子网 `128.32.0.0/16，/24，/25，/26`。每个子网可提供不同数量的主机。主机数受 IP 地址中没有被网络/子网号使用的剩余位限制。对于 IPv4 和 /24 前缀，允许有 32 - 24 = 8 （256 台主机）；对于 `/25` 有 （128 台），`/26` 有 （64 台）。主机和路由器的每个接口都需要用 IP 地址和子网掩码来描述，但掩码决定了网络拓扑的不同。基于路由器中运行的动态路由协议（如：OSPF，IS-IS，RIPv2），流量能正确地在同一站点中的主机之间流动，以及通过 `Internet` 前往或来自外部站点

有一个常见情况，即一个子网中只包含两台主机。当路由器之间被一条点到点链路连接，则每个端点都需要分配一个 IP 地址，常见做法是 IPv4 使用 `/31` 为前缀，目前也有建议 IPv6 使用 `/127` 为前缀

#### 广播地址

**在每个 IPv4 子网中，一个特殊地址被保留作为子网广播地址。子网广播地址通过将 IPv4 地址的网络/子网部分设置为适当值，以及主机部分的所有位设置为 1 而形成**。子网广播地址的构建方式为：对子网掩码取反，并于子网中任意主机地址（或等值的网络/子网前缀）进行按位或运算。

*IPv4 地址 128.32.1.14 和子网掩码 255.255.255.0 获取广播地址*

![](./Images/IP地址和子网掩码获取广播地址.png)

  子网广播地址由子网掩码首先取反，然后与 IPv4 地址进行或运算构建而成。在这种情况下，一个 `/24` 的子网掩码，剩余的 `32 - 24 = 8` 位设置为 1，得到一个十进制值 255 和子网广播地址 `128.32.1.255`

使用这种地址作为目的地的数据报，也被称为定向广播。理论上，这种广播可作为一个单独的数据报通过 `Internet` 路由直至到达目标子网，再作为一组广播数据报发送给子网中所有主机。即可以形成一个目的 IPv4 地址为 `128.32.255.255` 的数据报，并且通过连接网络将它发送到 Internet，这是，该数据报将发送给目标站点中的所有主机（定向广播，从安全的角度来看，它们至今在 `Internet` 中仍被禁用。路由器现在默认禁止转发定向广播，甚至完全省略支持能力）

除了子网广播地址，特殊用途地址 `255.255.255.255` 被保留为本地网络广播（也称为有限广播）它根本不会被路由器转发。虽然路由器可能不转发广播，但子网广播和连接在同一网络中的计算机的本地网络广播将工作，除非被终端主机明确禁用。这种广播不需要路由器；如果有的话，链路层的广播机制用于支持它们。广播地址通常与某些协议一起使用（如 UDP/IP，ICMP），因为这些协议不涉及 `TCP/IP` 那样的双方会话。IPv6 没有任何广播地址；广播地址可用于 IPv4 中，而 IPv6 仅使用组播地址

#### IPv6 地址和接口标识符

除了比 IPv4 地址长 4 倍这个因素，IPv6 地址还有一些额外的特点。IPv6 地址使用特殊前缀表示一个地址范围。一个 IPv6 地址范围是指它可用的网络规模。有关范围的重要例子包括节点本地（只用于同一计算机中同行），链路本地（只用于同一网络链路或 IPv6 前缀中的节点）或全球性（Internet范围）。在 IPv6 中，大部分节点通常在同一网络接口上使用多个地址。虽然 IPv4 也支持这样做，但是并不常见。一个 IPv6 节点中需要一组地址，包括组播地址

链路本地 IPv6 地址（和一些全球性 IPv6 地址）使用接口标识符（IID）作为一个单播 IPv6 地址的分配基础。除了地址是以二进制值 000 开始外，IID 在所有情况下都作为一个 IPv6 地址的低序位，这样它们必须在同一网络中有唯一前缀。IID 长度通常是 64 位，并直接由一个网络接口相关的链路层 MAC 地址形成，该地址使用修改的 EUI-64 格式或者由其他进程随机提供的值形成，以提供可防范地址跟踪的某种程度的隐私保护

在 IEEE 标准中，EUI 表示扩展唯一标识符。EUI-64 标识符开始于一个 24 位的组织唯一标识符，接着是一个由组织分配的 40 位扩展标识符，它由前面 24 位识别。OUI 由 IEEE 注册权威结构来维护和分配。EUI 可能是统一管理，本地管理的。在 `Internet` 环境下，这种地址通常是统一管理的。多年以来，很多 IEEE 标准兼容的网络接口（如以太网）在使用短格式的地址（48位的 EUI）。EUI-48 和 EUI-64 格式之间的显著区别是它们的长度

*EUI-48 和 EUI-64 格式*

![](./Images/EUI-48和EUI-64格式.png)

OUI 的长度是 24 位，并占据 EUI-48 和 EUI-64 地址的前三字节。这些地址的第一个字节的低两位分别是 u 位和 g 位。当 u 位被设置时，表示该地址是本地管理。当 g 位被设置时，表示该地址时一组或组播类型的地址。

一个 EUI-64 地址可以由 EUI-48 地址形成，将 EUI-48 地址的 24 位 OUI 值复制到 EUI-64 地址，并将 EUI-64 地址的第 4 和第 5 个字节的 16 位替换为 `1111111111111110` (十六进制 FFFE)，然后复制由组织分配的剩余位。

### 聚合

通过取消分类结构的 IP 地址，能分配各种尺寸的 IP 地址块。但是，这样并没有帮助较少路由表条目数。一条路由表条码告诉一个路由器向哪里发送流量。从本质上来说，路由器检查每个到达的数据报中的目的 IP 地址，找到一条匹配的路由表条目，并从该条目中提取数据报的“下一跳”。

在 Internet 环境中，可采用分层路由思想以一种特定方式减少 Internet 路由条目数。这通过一个称为路由聚合的过程来实现。通过将相邻的多个 IP 前缀合并成一个短前缀（称为一个聚合或汇聚），可以覆盖更多地址空间。

*IP聚合过程*

![](./Images/IP聚合过程.png)

*箭头表示将两个地址前缀聚合为一个，带下划线的前缀时每一步的结果。第一步 `190.154.27.0/26` 和 `!90.154.27.64` 可以聚合，这是由于它们数值相邻，但是 `190.154.27.192/26`不能聚合。通过与 `190.154.27.128/26` 相加，它们可经过两步聚合形成 `190.154.27.0/24`。最后，通过与相邻的 `190.154.26.0/24` 相加，生成聚合结果 `190.154.26.0/23`*

### 特殊用途地址

IPv4 和 IPv6 地址空间中都包括几个地址范围，它们被用于特殊用途（因此不能用于单播地址分配）

#### `IPv4` 特殊用途地址

* `0.0.0.0/8` 本地网络中的主机。仅作为源 IP 地址使用
* `10.0.0.0/8` 专用网络（内联网）的地址。这种地址不会出现在公共 Internet 中
* `127.0.0.0/8` `Internet` 主机回送地址（同一计算机）通常只用 `127.0.0.1`
* `169.254.0.0/16` 链路本地地址，只用于一条链路，通常自动分配
* `172.16.0.0/12` 专用网络（内联网）的地址，这种地址不会出现在公共 `Internet` 中
* `192.0.0.0/24` IETF 协议分配（IANA保留）
* `192.0.2.0/24` 批准用于文档中的 TEST-net-1 地址。这种地址不会出现在公共 Internet 中
* `192.88.99.0/24` 用于 6to4 中断（任播地址）
* `192.168.0.0/16` 专用网络（内联网）的地址。这种地址不会出现在公共 `Internet` 中
* `192.18.0.0/15` 用于基准和性能测试
* `198.51.100.0/24` TEST-net-2 地址。被批准用于文档中
* `203.0.113.0/24` TEST-net-3 地址。被批准用于文档中
* `224.0.0.0/4` IPv4 组播地址（即以前的 D 类），仅作为目的 IP 地址使用
* `240.0.0.0/4` 保留空间（以前的 D 类），除了 `255.255.255.255`
* `255.255.255.255/32` 本地网络（受限的）广播地址

#### `IPv6` 特殊用途地址

* `::/0` 默认路由条目，不用于寻址
* `::/128` 未指定地址，可作为源 IP 地址使用
* `::1/128` IPv6 主机回送地址，不用于发送出本地主机的数据报中
* `::ffff:0:0/96` IPv4 映射地址。这种地址不会出现在分组头部，只用于内部主机
* `::{ipv4-address}/96` IPv4 兼容地址。已过时，未使用
* `2001::/32` `Teredo` 地址
* `2001:10::/28` ORCHI（覆盖可路由加密散列标识符）。这种地址不会出现在公共 Internet 中
* `2001:db8::/32` 用于文档和实例的地址范围。这种地址不会出现在公共 `Internet` 中
* `2002::/16` `6to4` 隧道中继的 `6to4` 地址
* `3ffe::/16` 用于 `6bone` 实验，已过时，未使用
* `5f00::/16` 用于 `6bone` 实验。已过时，未使用
* `fc00::/7` 唯一的本地单播地址，不用于全球性的 `Internet`
* `fe80::/10` 链路本地单播地址
* `ff00::/8` IPv6 组播地址，仅作为目的 IP 地址使用

对于 IPv4 和 IPv6，没有指定作为特殊，组播或保留地址的地址范围可供单播使用。一些单播地址空间（IPv4 的前缀 `10/8`，`172.16/12`，`192.168/16`，以及 IPv6 的前缀 `fc00::/7`）被保留用于构建专用网络。来自这些范围的地址可用于一个站点或组织内部的主机和路由器之间的通信，但不能跨域全球性的 `Internet`，因此，这些地址有时也被称为**不可路由**的地址。即，它们不能在公共 `Internet` 中路由。专用，不可路由的地址空间管理完全由本地决定。IPv4 专用地址在家庭网络，中等规模和大型企业内部网络中很常见。它们经常与网络地址转换（NAT）结合使用，在 IP 数据报进入 `Internet` 时修改其中的 IP 地址。

#### `IPv4/IPv6` 地址转换

在有些网络中，可能需要在 IPv4/IPv6 之间转换。目前，已制定了一个用于单播转换的框架，一个基本功能是提供自动、基于算法的地址转换。该方案使用一种特殊地址格式，称为嵌入 IPv4 的 IPv6 地址。这种地址在 IPv6 地址内部包含 IPv4 地址。IPv6 前缀长度必须是下列数值之一：32，40，48，56，64，96

*IPv4地址嵌入IPv6地址*

![](./Images/IPv4嵌入IPv6之中.png)

*IPv4地址可以嵌入IPv6地址中，形成一个嵌入IPv4的IPv6地址。有6种不同的格式可用，这取决于使用的IPv6前缀长度。前缀`64:ff9b::/96`可用于IPv4和IPv6单播地址之间的自动转换*

前缀既可以是一个众所周知的前缀，也可以是组织为转换器分配的唯一前缀。如 `64:ff9b::/96`，第 64 至 71 位必须设置成为 0，以保持与指定标识符的兼容性。后缀的位被保留，并且应设置为 0。然后，采用简单方法来生成嵌入 IPv4 的 IPv6 地址：将 IPv6 前缀与 32 位的 IPv4 地址相串联，并确保第 64 位至 71 位被设置为 0 （如果有必要，插入）。在后缀的后面增加 0，直到生成一个 128 位地址。嵌入 IPv4 的 IPv6 地址使用 96 位前缀选项，该选项通常用 IPv6 映射地址来表示。

#### 组播地址

IPv4 和 IPv6 支持组播寻址。一个 IP 组播地址（组或组地址）标识一组主机接口，而不是单个接口。一般来说，一个组可以跨越整个 Internet。一个组所覆盖的网络部分称为组的范围。常见的范围包括节点本地（同一计算机）、链路本地（同一子网）、站点本地（适用于一些站点）、全球（整个 Internet）和管理。管理范围的地址可用于一个网络区域内已手动配置到路由器的地址。站点管理员可将路由器配置为管理范围边界，这意味着相关组的组播流量不会被路由器转发。站点本地和管理范围只在使用组播寻址时有效。

在软件的控制下，每个 Internet 主机中的协议栈能加入或离开一个组播组。当一台主机向一个组发送数据时，它会创建一个数据报， 使用（单播）IP 地址作为源地址，使用组播 IP 地址作为目的地址。已加入组的所有主机将接收发送到该组的任何数据报。发送方通常不知道主机是否接收到数据报，除非它们明确做出应答。事实上，发送方甚至不知道通常有多少台主机接收它的数据报

原有的组播模型已成为**任意源组播（ASM）**。在这种模型下，任何发送方可以发送给任何组；一个加入组的接收方被指定唯一的组地址。一种新方案称为**源特定组播（SSM）**，在每个组中只使用一个发送方。在这种情况下，当一台主机加入一个组后，它会被指定一个信道地址，其中包括一个组地址和一个源 IP 地址。 SSM 避免了 ASM 模型部署时的复杂性。

#### `IPv4` 组播地址

对于 IPv4，D 类空间（224.0.0.0 ~ 239.255.255.255）已被保留支持组播。28 位空闲意味着 `2-28 = 268435456` 个主机组（每个组时一个 IP 地址）。整个地址空间被分为几个主要部分，它建立在对路由分配和处理的基础上

![](./Images/支持组播的IPv4的D类地址空间.png)

到`224.255.255.255` 的地址块被分配给某些应用协议或组织使用，这些分配工作由 IANA 或 IETF 完成。本地网络控制块限制为发送方的本地网络；发送到这些地址的数据报不会被组播路由器转发。“所有主机”组（224.0.0.1）是这个块的一个组。互联网络控制块类似于本地网络控制范围，其目的是控制需要被路由到本地链路的流量。该地址块的一个例子是网络时间协议（NTP）组播组（224.0.1.1）

第一个 `Ad hoc`(特定)块用于保留一些地址，避免它们落入本地或互联网络控制块。在此范围内的大多数分配是用于商业服务，其中一些不（或永远不）需要全球地址分配；它们可能最终被返还以支持 `GLOP` 寻址。在 `SDP/SAP` 块中包含某些应用所使用的地址（如会话目录工具SDR，它使用会话通告协议SAP发送组播会议通告。新的会话描述协议SDP最初只是SAP的一个组成部分，当前它不仅用于IP组播，而且于其他机制一起描述多媒体会话）

其他主要地址块的出现稍晚于IP组播的演变。某些应用使用 SSM 块实现 SSM，结合自己的单播源地址形成一个 SSM 信道。在 GLOP 块中，组播地址基于主机的自治系统号，该主机处于应用分配地址的一端。AS 号用于 ISP 之间的 `Internet` 范围的路由协议，以聚合路由器和实现路由策略。AS 号最初是 16 位，现在已扩展到 32 位。GLOP地址的生成时将一个 16 位 AS 号放在 IPv4 组播地址的第 2 和第 3 字节，并且保留 1 字节的空间表示可能的组播地址（即多达 256 个地址）。它可在一个 16 位 AS 号和与这个 AS 号相关联的 GLOP 组播地址之间来回映射。

IPv4 组播地址分配机制将多个组播地址与一个 IPv4 单播地址前缀关联。这被称为基于**单播前缀的组播寻址（UBM）**。它在 `RFC6034` 中描述。它基于 IPv6 发展早期的一个类似结构。UBM 的 IPv4 地址范围是 `234.0.0.0` 至 `234.255.255.255`。单播地址需分配一个 `/24` 或更短的前缀以使用 UBM 地址。分配更短的地址（即 `/25` 或更长的前缀）必须使用一些其他机制。UBM 地址被构造成前缀 `234/8`，分配的单播前缀或组播 ID 的串联。

为了确定与一个单播分配相关的 UBM 地址，分配前缀只是简单地在前面添加前缀 `234/8`（如：单播 IPv4 地址前缀 `192.0.2.0/24` 有一个关联 UBM 地址 `234.192.0.2`，通过对组播地址简单地“左平移” 8 位，有可能确定一个组播地址的所有者。）

*IPv4的UBM地址格式*

![](./Images/IPv4的UBM地址格式.png)

*IPv4的UBM地址格式。为单播地址分配/24或更短的前缀，关联的组播地址分配基于前缀234/8，分配的单播前缀和组播组ID的串联。因此，较短的单播前缀分配包含更多单播和组播地址*

UBM地址比其他类型的组播地址分配有更多优点（如，用于 GLOP 寻址时，它们可以不受 16 位 AS 号限制。另外，它们可作为已存在的单播地址空间的分配结果。因此，使用组播地址的站点知道那些地址可用，并且不需要进一步协调。UBM地址可以比 GLOP 地址更好地分配，对应的 AS 号可分配到更细粒度，当前 Internet 中，一个 AS 号可以与多个站点关联，UBM 支持在地址和所有者之间的简单映射）

管理范围的地址块可用于限制分布在路由器和主机的特定集合中的组播流量。它可以看作组播对专用单播 IP 地址的模拟。这种地址不能用于将组播分发到 Internet，因为其中大多数流量被阻塞在企业边界。大型站点有时会划分管理范围的组播地址。用于某些特定范围

#### IPv6 组播地址

对于 IPv6，前缀 `ff00::/8` 已被预留给组播地址，并且 112 位可用于保存组号，可提供的组数为 `2^112` 

![](./Images/IPv6组播地址.png)

基本的IPv6组播地址格式包括4个标志位（0，保留；R，包含会合点；P，使用单播前缀；T，临时的）4 位范围值表示组播的范围（全球，本地）。组 ID 编码在低序的 112 位中。如果 P 或 R 位被设置，则使用一种代替格式

IPv6 组播地址的第 2 字节包含一个 4 位标志字段和一个 4 位范围 ID 字段。范围字段表示到某些组播地址的数据报的分配限制。十六进制值 0，3，f 保留。十六进制 6，7，9~d 未分配。

*IPv6范围字段的值*

![](./Images/IPv6范围字段的值.png)

很多 IPv6 组播地址由 IANA 分配为永久使用，并且故意跨越多个地址范围。这些组播地址对每个范围都有一定偏移量（这些地址被称为相对范围或可变范围）。

在 IPv6 中，当 P 和 R 位字段设置位 0 时，使用如下组播地址格式

![](./Images/IPv6组播地址标志.png)

当 P 设置为 1，无须基于每个组的全球性许可，对组播地址有两个可选方法。第一种方法为基于单播前缀的 IPv6 组播地址分配，由 ISP 或地址分配机构提供单播前缀分配，并且有效分配一个组播地址集合，从而限制了因避免重复而需全球协调的数量。第二种方法为链路范围的 IPv6 组播，使用接口标识符，并且组播地址是基于主机的 IID。当 T 位字段被设置时，表示组播地址是临时或动态分配的；当 P 位字段被设置位 1，T 位也必须被设置位 1。此时 ，使用基于单播地址前缀的特殊格式的 IPv6 组播地址

*单播地址前缀的特殊格式的IPv6组播地址*

![](./Images/单播地址前缀的特殊格式的IPv6组播地址.png)

*IPv6 组播地址可以基于单播 IPv6 地址来创建，此时：P 位设置为 1，单播前缀和 32 位的组 ID 被加入地址。这种形式的组播地址分配减少了全球地址分配协议的需求*

使用基于单播前缀的地址改变组播地址格式，包括一个单播前缀及其长度，以及一个更小的（32位）组 ID。该方案的目的是提供全球唯一的 IPv6 组播地址分配方式，同时不需要提出新的全球性机制。由于 IPv6 单播地址已分配全球性的前缀单元，所以在组播地址种可以使用这个前缀中的位，从而在组播应用中利用现有的单播地址分配方法。即，一个组织分配了一个单播前缀 `3ffe:ffff:1::/48`，那么它随之分配了一个基于单播的组播前缀 `ff3x:30:3ffe:ffff:1::/96`，其中 x 是任何有效范围。SSM 通过设置前缀长度和将前缀字段设置为 0 来支持这种格式，以便有效地将前缀 `ff3x::/32` 用于所有这类 IPv6 SSM 组播地址

为了创建唯一的链路本地范围的组播地址，可使用一种基于 IID 的方法，当只需要链路本地范围时，这种方法是基于单播前缀分配的首选，这种情况下，可使用另一种形式的 IPv6 组播地址结构：

*IID组播地址结构*

![](./Images/IID组播地址结构.png)

*IPv6链路范围的组播地址格式。只适用于链路范围内的地址，组播地址可以结构IPv6接口ID和组ID来形成。这种映射是直接的，所有地址使用前缀形式`ff3:0011/32`，其中 X 是范围 ID 并且小于 3*

除了前缀长度字段被设置为 255，并将随后字段中的前缀替换为 IPv6 的 IID。这个结构的优点是不需要提供前缀以形成组播地址。

R 位字段。当使用基于单播前缀的地址（P 位被设置）时，它表示组播路由协议需要知道一个会合点（会合点（RP）时一个路由器中用于处理一个或多个组播组的组播路由的 IP 地址。RP 用于 PIM-SM 协议，以帮助参加同一组播组中的发送方和接收方找到对方。Internet 范围的组播部署遇到的问题之一时会合点定位。这种方法重载 IPv6 组播地址以包含一个 RP 地址。因此，从一个组地址找到一个 RP 是简单的，只需从中选择合适的位的子集）

*P位设置时组播地址格式*

![](./Images/P位设置时组播地址格式.png)

*RP的单播IPv6地址可嵌入IPv6组播地址。这样，它可以直接找到用于路由的RP关联的地址。RP被用于组播路由系统，以协调不在同一子网的组播发送方和接收方*

*IPv6组播地址空间中的保留地址*

![](./Images/IPv6组播地址空间的保留地址.png)

### 分配

IP地址空间通常被分配为大的块，这由一些分层次组织的权威机构完成。权威机构是为
备种“所有者”分配地址空间的组织, “所有者”通常是ISP或其他较小的权威机构。权威
机构经常参与全球单播地址空间分配,但有时也分配其他类型的地址(组播和特殊用途)。权
威机构为用户分配一个不限时的地址块，或是一个限时(例如实验)的地址块。这个层次结
构的顶部是IANA[IANA] ，它负责分配IP地址和 `Intemet` 协议使用的其他号码

#### 单播

对于单播 IPv4 和 IPv6 的地址空间，IANA 将分配权限主要委托给几个地区性 `Internet` 注册机构。RIR 之间通过一个组织（号码资源组织 NRO）互相协作。这些实体通常处理较大的地址块。他们为一些国家运营的小型注册机构和大型 ISP 分配地址空间。ISP 为自己和自己的客户提供地址空间。当用户等级 `Internet` 服务时，他们通常以地址前缀形式使用 ISP 地址空间的一部分。这些地址范围由客户的 ISP 拥有和管理，并被称为供应商聚合的地址，这是由于它们包含一个或多个前缀，并可与 ISP 的其他前缀实现聚合。

#### 单播地址分配

可获得的最简单的 `Intemet` 服务是由 ISP 提供一个在一台计算机上使用的 IP 地址(在美国通常只是IPv4)。例如，对于DSL服务，单个地址可被分配到一个点到点链路的一端，并可能只是暂时的。

很多拥有多台计算机的 `Intemet`用户发现，只有一台计算机连接到 `Internet` 并不是理想情况。因此，他们通常拥有家庭局域网(LAN)或无线局域网(WLAN)，并使用一台路由器或主机作为路由器连接`Internet`这种配置与单个计算机的情况相似，除了路由器将分组从家庭网络转发到 ISP，它们也执行 NAT (在Windows中称为 `Intemet` 连接共享(ICS))，在与 ISP 通信时重写分组中的 IP 地址。从ISP的角度来看：只有一个 IP 地址被使用。目前，这些操作大部分是自动的，因此需要手动配置的地址很少。路由器使用 DHCP 为家庭用户提供自动地址分配。如果有必要，它们也为与 ISP  建立链路提供地址分配

*单个供应商多个网络多个地址*

![](./Images/典型企业网络.png)

*一个典型的小型到中型规模的企业网络。该网络已被分配 128.32.2.64/26 范围内的 64 个公开的 IPv4 地址。DMZ 网络包含 Internet 中可见的服务器。内部路由器使用 NAT 为企业内部的计算机提供 internet 访问*

