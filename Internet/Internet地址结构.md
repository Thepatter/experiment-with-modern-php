## Internet 地址结构

### 概述

连接到 `Internet` 的每个设备至少有一个 IP 地址。基于 `TCP/IP` 协议的专用网络中使用的设备也需要 IP 地址。在任何情况下，IP 路由器实现的转发程序使用 IP 地址来识别流量去向。IP 地址也表示 流量的来源

### 表示 IP 地址

#### IPv4 地址

这些地址通常采用点分四组或点分十进制表示法，每个数字是一个非负整数，范围为 `0~255`，代表整个 IP 地址的四分之一。点分四组表示法是编写完整的 IPv4 地址（32 位非负整数）的简单方式，它使用便捷的十进制数

#### IPv6 地址

在 IPv6 中，地址的长度是 128 位，是 IPv4 地址长度的 4 倍。IPv6 地址的传统表示法是采用称为块或字段的四个十六进制数，这些块由冒号分隔。一些已取得共识的 IPv6 地址简化表示法已被标准化（RFC4291）：

* 一个块中前导的零不必书写
* 全零的块可以省略
* 在 IPv6 格式中嵌入 IPv4 地址可使用混合符号形式，紧接着 IPv4 部分的地址块的值为 `ffff`，地址的其余北方使用点分四组格式。如 `IPv6` 地址 `::ffff:10.0.0.1` 表示 IPv4 地址 `10.0.0.1`。它被称为 IPv4 映射的 IPv6 地址
* IPv6 地址的低 32 位通常采用点分四组表示法。因此，IPv6 地址 `::0102:f001` 相当于地址 `::1.2.240.1`。它被称为 IPv4 兼容的 IPv6 地址。IPv4 兼容地址与 IPv4 映射地址不同；它们只是能用类似 IPv4 地址的方式书写或由软件处理方面给人以兼容的感觉。这种地址最初用于 IPv4 和 IPv6 之间的过渡计划，但现在不再需要
* 在某些情况下（如表示一个包含地址的 URL 时），IPv6 地址中的冒号分隔符可能与其他分隔符混淆，在这种情况下，用括号字符 `[]` 包围 IPv6 地址。如 `http://[2001:0db8:85a3:1319:8a2e:0370:7344]:443/`

`[RFC4291]` 提供的灵活性造成了不必要的混淆，因为能用多种方式表示相同的 IPv6 地址。`[RFC5952]` 制定了一些规则，以缩小选择范围，同时与 `[RFC4291]` 保持兼容：

* 前导的零必须压缩（如：，`2001:0db8::0022` 变成 `2001:db8::22`）
* `::` 只能用于影响最大的地方（压缩最多的零），但并不只是针对 16 位的块。如果多个块中包含等长度的零，顺序靠前的块将被替换为 `::`
* `a~f` 的十六进制数用小写表示

### 基本的 IP 地址结构

IPv4 地址空间中有 `4294967296` 个可能的地址，而 IPv6 的地址个数为 `2-128` 个地址。由于拥有大量地址，可以方便地将地址空间划分成块，IP 地址可根据类型和大小分组。大多数 IPv4 地址块最终被细分为一个地址，用于识别连接 `Interenet` 或某些专用的内联网的计算机网络接口。这些地址称为**单播地址**，其他类型的地址包括广播、组播和任播地址，它们可能涉及多个接口，还有一些特殊用途的地址。

#### 分类寻址

当最初定义 `Internet` 地址结构时，每个单播 IP 地址都有一个网络部分，用于识别接口使用的 IP 地址在那个网络中可被发现；以及一个主机地址，用于识别由网络部分给出的网络中的特定主机。因此，地址中的一些连续位称为**网络号**，其余位称为**主机号**。当时，大多数主机只有一个网络接口，因为术语接口地址和主机地址有时交替使用

现实中的不同网络可能有不同数量的主机，每台主机都需要一个唯一的 IP 地址。一种划分方法是基于当前或预计的主机数量，将不同大小的 IP 地址空间分配给不同的站点。地址空间的划分涉及五大类。每类都基于网络中可容纳的主机数量，确定在一个 32 位的 IPv4 地址中分配给网络号和主机号的位数

*五类地址*

![](./Images/五类地址.png)

​                                                                                                                                                                                                                                                                                                                                                  IPv4 地址空间最初分为五大类。A、B、C 类用于为  `Internet` (单播地址）中的接口分配地址，以及其他一些特殊情况下使用。类由地址中的头几位来定义：0 为 A 类，10 为 B 类，110 为 C 类，D 类地址供组播使用，E 类地址保留

*分类地址空间划分*

![](./Images/分类地址空间划分.png)

这些数字是不准确的，有几个地址通常不作为单播地址使用。特别是，地址块中的第一个和最后一个地址通常不使用。

#### 子网寻址

Internet 发展初期首先遇到一个困难，那就是很难为接入 `Internet` 的新网段分配一个新的网络号。80 年代后，随着局域网（LAN）的发展和增加，这个问题变得更棘手。为了解决这个问题，人们想到一个方式，在一个站点接入 Internet 后为其分配一个网络号，然后由站点管理员进一步划分本地的子网数。在不改变 Internet 核心路由基础设施的情况下解决这个问题。

实现这个想法需要改变一个 IP 地址的网络部分和主机部分的限制，但这样做只是针对一个站点自身而言；Internet 其余部分将只能“看到"传统的 A 类、B 类、C 类部分。支持此功能的方法称为**子网寻址**。通过子网寻址，一个站点被分配一个 A，B，C 类的网路号，保留一些剩余主机号进一步用于站点内分配。该站点可能将基础地址中的主机部分进一步划分为一个子网号和一个主机号。从本质上来说，子网寻址为 IP 地址结构增加了一个额外部分，但它没有为地址增加长度。因此，一个站点管理员能在子网数和每个子网中预期的主机数之间折中，同时不需要与其他站点协调

子网寻址提供额外灵活性的代价是增加成本。由于当前的子网字段和主机字段的定义是由站点指定的（不是由网络号分类决定），一个站点中所有路由器和主机需要一种新的方式，以确定地址中的子网部分和其他的主机部分。在出现子网之前，这个信息可直接从一个网络号中获得，只需知道是 A 类、B 类 或 C 类地址（由地址的前几位表示）

*B类地址划分子网*

![](./Images/B类地址划分子网.png)

一个B类地址被划分子网，它使用 8 位作为子网 ID，提供 256 个子网和每个子网中 254 台主机（当前每个子网的第一个和最后一个地址无效，即从整个分配范围中除去第一个和最后一个地址），这种划分可由网络管理员改变。该站点将每个地址的前 16 位固定为某些特定号码，这是由于这些位已被分配给核心机构。后 16 为（仅用于在无子网的 B 类网络中创建主机号）限制可以由站点的网络管理员按需分配。只有划分子网的网络中的主机和路由器知道子网结构。在需要进行子网寻址之前，Internet 其他部分仍将它作为站点相关的地址来看待。

*子网掩码工作*

![](./Images/子网掩码工作.png)

某个站点被分配一个典型的 B 类网路号 128.32。网络管理员决定用于站点范围内的子网掩码为 `255.255.255.0`，提供 256 个子网，每个子网可容纳 256 - 2 = 254 台主机。同一子网中每台主机的 IPv4 地址拥有相同子网号。左侧的局域网段中主机的 IPv4 地址开始于 128.32.1，右侧的所有主机开始于 `128.32.2`

在上图中，显示了一个虚拟的站点，使用一个边界路由器（即 `Internet` 的一个连接点）连接 `Internet` 和两个内部局域网。x 的值可以是 `[0, 255]`，范围内的任意值。每个以太网是一个 IPv4 子网，整体分配为 B 类地址的网路号 `128.32`。Internet 中其他站点要访问这个站点，目的地址以 `128.32` 开始的所有流量直接由 Internet 路由系统交给边界路由器（特别是其接口的 IPv4 地址 137.164.23.30）。在这点上，边界路由器必须区分 `128.32` 网络中的不同子网。特别是，它必须能区分和分离目的地址为 `128.32.1.x` 和目的地址为 `128.32.2.x` 的流量。这些地址分别表示子网号 1 和 2，它们都采用 `128.32` 的 B 类网路号。为了做到这点，路由器必须知道在地址中如何找到子网 ID。这可通过一个配置参数实现。

