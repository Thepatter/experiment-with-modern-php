## 网络概述

### 分层

网络协议通常分不同的层次进行开发，每一层分别负责不同的通信功能。一个协议族，如 TCP/IP 是一组不同层次上的多个协议的组合。当前网络模型是常见的 TCP/IP 4层协议：

* 链路层

  数据链路层或网络接口层，通常包括操作系统中的设备驱动程序和计算机中对于的网络接口卡。它们一起处理与电缆（或其他任何传输媒介）的物理接口细节

* 网络层

  即处理分组在网络中的或者，如分组的选路。在 TCP/IP 协议族中，网络层协议包括 IP 协议（网际协议），ICMP 协议（Internet互联网控制报文协议），以及 IGMP 协议（Internet 组管理协议）

* 传输层

  传输层主要为两台主机上的应用程序提供端到端的通信。在 TCP/IP 协议族中，有两个互不相同的传输协议：

  TCP 传输控制协议，TCP 为两台主机提供高可靠性的数据通信。它所做的工作包括把应用程序交给它的数据分成合适的小块交给下面的网络层，确认接收到的分组，设置发生最后确认分组的超时时钟等，由于传输层提供了高可靠性的端到端的通信，因此应用层可以忽略这些细节

  UDP 则为应用层提供一种非常简单的服务，它只是把数据包的分组从一台主机发送到另一台主机，但并不保证该数据报能到达另一端。任何必需的可靠性必须由应用层来提供

* 应用层

  应用层负责处理特定的应用程序细节，几乎各种不同的 TCP/IP 实现都会提供这些通用的应用程序 `Telnet` 远程登陆，`FTP` 文件传输协议，`SMTP` 简单邮件传送协议，`SNMP` 简单网络管理协议

### TCP/IP 的分层

TCP 和 UDP  是两种最为著名的运输层协议，二者都使用 IP 作为网络层协议，虽然 TCP 使用不可靠的 IP 服务，但它却提供一种可靠的运输层服务。UDP 为应用程序发送和接收数据报。一个数据报是指从发送方传输到接收方的一个信息单元。UDP 是不可靠的，它不能保证数据报能安全无误地到达最终目的。

IP 是网络层上的主要协议，同时被 TCP 和 UDP  使用。TCP 和 UDP 的每组数据都通过端系统和每个中间路由器中的 IP 层在互联网中进行传输。ICMP 是 IP 协议的附属协议。IP 层用它来与其他主机或路由器交换错误报文和其他重要信息。IGMP 是 Internet 组管理协议。它用来把一个 UDP 数据报多播到多个主机。ARP 地址解析协议和 RARP 逆地址解析协议是某些网络接口（如以太网和令牌环网）使用的特殊协议，用来转换 IP 层和网络接口层使用的地址。

### 互联网的地址

互联网上的每个接口必须有一个唯一的 Internet 地址即使 IP 地址。IP 地址长 32 bit。Internet 地址并不采用平面形式的地址空间，IP 地址具有一定的结构，五类不同的互联网地址格式如下：

*五类 IP 地址*

![](./Images/五类IP地址.png)

这些 32 位的地址通常写成四个十进制的数，其中每个整数对应一个字节。这种表示法为“点分十进制表示法”。区分各类地址的最简单的方法是看它的第一个十进制整数，各类 IP 地址的范围

A  0.0.0.0 到 127.255.255.255；B 128.0.0.0 到 191.255.255.255；C 192.0.0.0 到 223.255.255.255；D 224.0.0.0 到 239.255.255.255；E 240.0.0.0 到 247.255.255.255

### 域名系统

域名系统（DNS）是一个分布的数据库，由它来提供 IP 地址和主机名之间的映射信息。

### 封装

当应用程序用 TCP 传送数据时，数据被送入协议栈中，然后逐个通过每一层直到被当作一串比特流送入网络。其中每一层对收到的数据都要增加一些首部信息（有时还要增加尾部信息）。TCP 传给 IP 的数据单元称作 TCP 报文段（TCP segment）。IP 传给网络接口层的数据单元称作 IP 数据报（IP datagram）即分组，分组既可以是一个 IP 数据报，也可以是 IP 数据报的一个片 （fragment）通过以太网传输的比特流成为帧（Frame）。以太网数据帧的物理特性是其长度必须在 46-1500 字节之间（`ip address` 命令的 mtu 后的数字）。

*数据进入协议栈时的封装过程*

![](./Images/数据进入协议栈时的封装过程.png)

UDP 数据与 TCP 数据基本一致。唯一不同的是 UDP 传给 IP 的信息单元称作 UDP 数据报（UDP datagram），而且 UDP 的首部长为 8 字节。由于 TCP、UDP、ICMP、IGMP 都要向 IP 传送数据，因此 IP 会在生成的 IP 首部中存入一个长度为 8 bit 的数值，成为协议域。1 为 ICMP 协议，2 为 IGMP 协议，6 为 TCP 协议，17 为 UDP 协议。类似的，传输层协议在生成报文首部时要存入一个应用程序的标识符。TCP 和 UDP 都用一个 16 bit 的端口号来表示不同的应用程序。TCP 和 UDP 把源端口号和目的端口号分别存入报文首部中。网络接口分别要发送和接收 IP、ARP、RARP 数据，因此会在以太网的帧首部中加入 16 bit 的帧类型域。

### 分用

当目的主机收到一个以太网数据帧时，数据就开始从协议栈中由低向上升，同时去掉各层协议加上的报文首部。每层协议都要去检查报文首部中的协议标识，以确定接收数据的上层协议。这个过程称为分用（Demultiplexing）

*以太网数据帧的分用过程*

![](./Images/以太网数据帧的分用过程.png)

**ICMP和IGMP事实上是 IP的附属协议。但 ICMP 和 IGMP 报文都被封装在 IP 数据报中，ARP 和 RARP 有各自的以太网数据帧类型。**

客户-服务器模型

大部分网络应用程序在编写时都假设一端是客户，另一端是服务器，其目的是为了让服务器为客户提供一些特定的服务，可以将这种服务分为两种类型：重复型或并发型。重复型服务器通过以下步骤进行交互：l1.等待一个客户请求的到来。l2.处理客户请求。l3.发送响应给发送请求的客户。l4。返回l1步。重复型服务器主要的问题是在 l2 状态，在这个时候，它不能为其他客户提供服务。并发服务器采用以下步骤：C1.等待一个客户请求的到来。C2.启动一个新的服务器来处理这个客户的请求（这期间可能生成一个新的进程、任务或线程，并依赖底层操作系统的支持，并处理客户请求并返回，处理结束后，终止这个新服务器）。C3.返回 C1。并发服务器的优点在于它是利用生成其他服务的方法来处理客户请求。即，每个客户都有它自己对应的服务器。如果操作系统允许多任务，那么就可以同时为多个客户服务。一般来说，TCP 服务器是并发的，而 UDP 服务器是重复的，但也存在一些例外

### 端口号

TCP 和 UDP 采用 16 bit 的端口号来识别应用程序。这些端口号的选择是：服务器一般都是通过知名端口号来识别的。任何TCP/IP实现所提供的服务都用知名的 1- 1023 之间的端口号。这些知名端口号由 Internet 号分配机构来管理。客户端通常对它所使用的端口号并不关心，只需保证该端口号在本机上是唯一的就可以。客户端口号又称作临时端口号（它通常只是在用户运行该客户程序时才存在，而服务器则只要主机运行，其服务就运行）

大多数 Unix 系统的文件 `/etc/services` 都包含了熟知的端口号。使用如下语句查寻

```shell
grep domain /etc/services
```

Unix 系统有保留端口号的概念，只有具有超级用户特权的进程才允许给它自己分配一个保留端口号（这些端口位于 1~1023 之间，一些应用程序将它作为客户与服务器之间身份认证的一部分）

### 应用编程接口

使用 TCP/IP 协议的应用程序通常采用两种应用编程接口（API：socket）和 TLI（运输层接口：Transport Layer Interface）