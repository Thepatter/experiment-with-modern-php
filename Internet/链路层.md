## 链路层

### 概述

TCP/IP 支持多种不同的链路层，它依赖于使用的网络硬件类型：有线局域网（以太网），无线网络（WI-FI）；基于蜂窝技术的无线数据服务（LTE）。

大多数链路层技术都有一个相关的协议，描述由网络硬件传输的相应 PDU（帧）格式。以区分更高层的 PDU 格式。帧格式通常支持可变的帧长度，范围从几字节到几千字节。这个范围的上限为**最大传输单元（MTU）**。有些网络技术（调制解调器和串行线路）不强制规定最大的帧，因此它们可以由用户来配置

### 以太网和 IEEE 802 局域网/城域网标准

#### 以太网帧格式

所有的以太网（802.3）帧都基于一个共同的格式。在原有规范的基础上，帧格式已被改进以支持额外功能。以太网帧开始是一个**前导**字段，接收器电路用它确定一个帧的到达时间，并确定编码位之间的时间量。由于以太网是一个异步的局域网（即每个以太网接口卡中不保持精确的时钟同步），从一个接口到另一个接口的编码位之间的间隔可能不同。前导是一个公认的模式（典型值是 `0xAA`)，在发现**帧起始分隔符**（SFD）时，接收器使用它“恢复时钟”。SFD 的固定值 `0xAB`

*以太网帧*

![](./Images/以太网帧.png)

*以太网帧格式包含一个源地址和目的地址、一个重载的长度/类型字段、一个数据字段和一个帧校验序列（CRC32）。基本帧格式提供了一个标签，其中包含一个 VLAN ID 和优先级信息（802.1p/q)，以及一个最近出现的可扩展标签。前导和 SFD 被用于接收器同步。当以太网以半双工模式运行在 100Mb/s 或以上速率时，其他位可能被作为载体扩展添加到短帧中，以确保冲突检测电路的正常运行*

* 基本的帧格式包括 48 位（6字节）的**目的地址**（DST）和**源地址**（SRC）字段。这些地址有时也采用其他名称，如：MAC地址，链路层地址，802地址，硬件地址，物理地址。以太网帧的目的地址也允许寻址到多个站点（广播或组播）广播功能用于 ARP 协议，组播功能用于 ICMPv6 协议，以实现网络层地址和链路层地址之间的转换

* 源地址后是**类型**字段，或**长度**字段。在多数情况下，它用于确定头部后面的数据类型。TCP/IP 网络使用的常见值包括 IPv4（0x0800），IPv6（0x86DD），ARP（0x0806)。0x8100 表示一个 Q 标签帧（可携带一个“虚拟局域网”或 802.1q 标准的 VLAN ID）。一个以太网帧的基本大小是 1518 字节，但是最近的标准将该值扩大到 2000 字节。

* 当前的 802.3-2008 标准采用修改后的 802.3 帧格式，提供最大为 482 字节的“标签”，它携带在每个以太网帧中。这些较大的帧被称为信封帧，长度最大的可能达到 2000 字节。包含 802.1p/q 标签的帧称为 Q 标签帧，即信封帧。但是，并非所有信封帧必然是 Q 标签帧

* **有效载荷**：这里放高层 PDU （IP 数据报）的地址。传统上，以太网的有效载荷一直是 1500 字节，它代表以太网的 **MTU**。目前，大多数系统以太网使用 1500 字节的 MTU，虽然在必要时它可设置为一个较小的值。有效载荷有时被填充数个 0，以确保帧在总体长度符合最小长度要求
* 有效载荷后是**循环冗余校验（CRC）**字段位于尾部，有 32 位。

#### 帧大小

以太网帧有最小和最大尺寸。最小的帧是 64 字节，要求数据区（有效载荷）长度（无标签）最小为 48 字节。当有效载荷较小时，填充字节（值为 0）被添加到有效载荷尾部，以确保达到最小长度

传统以太网的最大帧长度是 1518 字节（包括 4 字节 CRC 和 14 字节头部）。选择这个值是一个折中：如果一个帧中包括一个错误（接收到不正确的 CRC 校验），只需重发 1.5KB 以修复该问题。MTU 大小限制为 1500 字节。为了发送一个更大的消息，则需要多个帧（如，对于 TCP/IP 网络常用的较大尺寸 64 KB，需要至少 44 个帧）

由多个以太网帧构成一个更大的上层 PDU 的后果是，每个帧都贡献了一个固定开销（14 字节的头部和 4字节的 CRC）。为了允许以太网硬件接收电路正确恢复来自网络的数据，并未其他站提供将自己的流量与已有流量分开的机会，以太网帧在网络中不能无缝地压缩在一起。**在帧开始处定义了 7 字节前导和 1 字节 SFD 之外，还指定了 12 字节的包间距（IPG）时间**，因此，每帧的效率最多为 1500/（12 + 8 + 14 + 1500 + 4) = 0.975293，一种提高效率的方式是：**在以太网中传输大量数据时，尽量使帧尺寸更大一些，这可采用以太网巨型帧来实现**，它是一种非标准的以太网扩展（主要在 1000MB/s 以太网交换机中使用），通常允许帧尺寸高达 9000 字节。有效环境使用的帧超过 9000 字节为超级巨型帧。这些较大的帧通常无法与较小的 1518 字节的帧互操作。

#### 802.1p/q 虚拟局域网和 QoS 标签

为了解决大型多用途交换网络运行中的间题,，IEEE采用一种称为虚拟局域网(VLAN)的功能扩展802 LAN标准，它被定义在802.1q [802.1Q￣2005]标准中。兼容的以太网交换机将主机之间的流量分隔为常见的 `VLAN` 。正是由于这种分隔，连在同一交换机但在不同VLAN中的两台主机，它们之间的流量需要一台路由器来传递。已研发出交换机/路由器组合设备来满足这种需求。路由器性能最终得到改进以匹配VLAN交换性能。因此，VLAN的吸引力已有所减弱，现代高性能路由器逐渐取代它们。尽管如此，它们仍在使用，在某些环境中仍受欢迎，因此有必要了解它们。

工作站到 VLAN 的映射有几种方法。通过端口分配 VLAN 是一种简单而常见的方法，交换机端口所连接的站被分配在一个特定 VLAN 中，这样连接的任意站就都成为 VLAN 中的成员。其他选择包括基于 MAC 地址的 VLAN，以太网交换机使用表将一个站的 MAC 地址映射到一个 VLAN。

当不同的 VLAN 中的站连接在同一交换机时，交换机确保流量不在两个 VLAN 之间泄漏，无论这些站使用哪种类型的以太网接口。当多个 VLAN 跨越多个交换机（中继）时，在以太网帧发送到另一台交换机之前，需要使用 VLAN 来标记该帧的归属。使用一个 VLAN 标签（或头部）的标记，其中包含 12 位 VLAN 表示符号（提供 4096 个 VLAN，但保留 VLAN 0 和 VLAN 4095）。它还包含支持 QoS 的 3 位优先级（定义在 802.1p/q 标准中）。

802.1p规定了在帧中表示QoS标识符的机制0 802.1p头部包括一个3位优先级字段，它用于表明一个QoS级别。这个标准是802.1qVLAN标准的扩展。这两个标准可以一起工作，并在同一头部中共享某些位。它用3个有效位定义了8个服务级别。 0级为最低优先级，用于传统的尽力而为的流量。7级为最高优先级，可用于关键路由或网管功能。这个标准规定了优先级如何被编码在分组中，但没指定如何控制哪些分组采用哪个级别，以及实现优先级服务的底层机制，这些可由具体的实现者来定义

控制802.1p/q信息的Linux命令是 `vconfig`。它可用来添加和删除虚拟接口，即与物理接口相关联的 `VLAN ID`它也可用来设置802.1p优先级，更改虚拟接口确定方式，改变由特定 `VLAN ID` 标记的分组之间的映射。以及协议在操作系统中处理时如何划分优先级



