### 部署与监控

#### 监控 Spring boot

##### Actuator

Actuator 提供了生产环境可用的特性，包括监控 Spring-boot 应用和获取它的各种指标，Actuator 提供了各种端点支持 HTTP 和 JMX MBean 使用

###### 配置

1. 依赖

   ```xml
   <dependency>
   	<groupId>org.springframework.boot</groupId>
     <artifactId>spring-boot-starter-actuator</artifactId>
   </dependency>
   ```

2. 配置基础路径

   默认情况下，所有端点的路径都带有 /actuator 前缀，可以通过 management.endpoint.web.base-path 属性来修改

3. 启用 Actuator 端点

   * management.endpoints.web.exposure.include 

     指定暴露的端点，使用逗号分隔

   * management.endpoints.web.exposure.exclude

     指定非暴露的端点

     ```yml
     # 暴露所有端点，除了 threaddump 和 headdump
     management:
     	endpoints:
     		web:
     			exposure:
     				include: '*'
     				exclude: threaddump,headdump
     		# 显示应用健康详情
     		health:
     			show-details: always
     ```

   *提供端点*

   |     HTTP 方法     |      路径       |                             描述                             | 默认启用 |
   | :---------------: | :-------------: | :----------------------------------------------------------: | :------: |
   |        GET        |  /auditevents   |                 生成所有已触发的审计事件报告                 |    否    |
   |        GET        |     /beans      |              描述 Spring 应用上下文中所有 bean               |    否    |
   |        GET        |   /conditions   | 生成自动配置条件通过或失败的报告，这些条件会指定应用上下文中 bean 的创建 |    否    |
   |        GET        |  /configprops   |                 描述所有配置属性以及当前的值                 |    否    |
   | GET、POST、DELETE |      /env       |      生成 Spring 应用可用的所有属性源以及可用属性的报告      |    否    |
   |        GET        | /env/{toMatch}  |                     描述某个环境属性的值                     |    否    |
   |        GET        |     /health     | 返回聚合的应用健康状态，可能会包含外部依赖应用的健康状态，可能：UP 外部系统已启动且可访问，DOWN 外部系统已经停机或不可访问 UNKNOWN 外部系统的状态尚不清楚 OUT_OF_SERVICE 外部系统可以访问，但目前不可用 |    是    |
   |        GET        |    /heapdump    |                       下载堆 dump 文件                       |    否    |
   |        GET        |   /httptrace    |                生成最近 100 个请求的跟踪结果                 |    否    |
   |        GET        |      /info      |                  返回定义的关于该应用的信息                  |    是    |
   |        GET        |    /loggers     |     生成应用中源码包的列表，会包含配置以及生效的日志级别     |    否    |
   |     GET、POST     | /loggers/{name} | 返回指定 logger 配置的和生效的日志级别，生效的日志级别可以通过 POST 请求修改 |    否    |
   |        GET        |    /mappings    |          生成所有 HTTP 映射及其对应处理器方法的报告          |    否    |
   |        GET        |    /metrics     |                      返回指标分类的列表                      |    否    |
   |        GET        | /metrics/{name} |                   返回给定指标的多维度值集                   |    否    |
   |        GET        | /scheduledtasks |                      列出所有的调度任务                      |    否    |
   |        GET        |   /threaddump   |                    返回所有应用线程的报告                    |    否    |
   |        GET        |    /actuator    |                   列出所有的 actuator 端点                   |    是    |

   除了 /heapdump 外，其他还提供了 JMX MBean

###### 自定义端点

Actuator 端点并非通过 Spring MVC  实现，通过为类添加 @Endpoint 注解来实现，操作的方法通过 @ReadOperation、@WriteOperation、@DeleteOperation 注解实现。

##### Admin

是一个管理类的 Web 前端应用，使得 Actuator 的端点更容易被使用，由服务端和客户端组成，服务端负责收集并展现 Actuator 数据，展现的数据则是由一个或多个配置了 Admin 客户端的 Spring boot 提供

###### admin Server

1. 依赖

   ```xml
   <dependency>
   	<groupId>de.codecentric</groupId>
     <artifactId>spring-boot-admin-starter-server</artifactId>
   </dependency>
   ```

2. 在主配置类上使用 @EnableAdminServer 注解启用。

###### admin Client

Admin 服务器注册 Spring Boot Admin 客户端可以使用：每个应用显式向 Admin 服务器注册自身

1. 依赖

   ```xml
   <dependency>
   	<groupId>de.codecentric</groupId>
     <artifactId>spring-boot-admin-starter-client</artifactId>
   </dependency>
   ```

2. 向服务器注册自身，配置 client.url 属性为 Admin 服务器的根路径

   ```yml
   spring.boot.admin.client.url=http://localhost:9090
   ```

Admin 通过 Eureka 服务注册中心发现服务