## 配置文件

#### Spring 配置

##### 部署描述符 

*web.xml*

```xml
<?xml version="1.0" encoding="UTF-8"?>
<web-app version="3.0"
xmlns="http://java.sun.com/xml/ns/javaee"
xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
xsi:schemaLocation="http://java.sun.com/xml/ns/javaee
                    http://java.sun.com/xml/ns/javaee/web-app_3_0.xsd">
    <servlet>
    	<servlet-name>springmvc</servlet-name>
        <servlet-class>
            org.springframework.web.servlet.DispatcherServlet
        </servlet-class>
        <init-param>
            <param-name>contextConfigLocation</param-name>
            <param-value>
                /WEB-INF/config/springmvc-config.xml
            </param-value>
        </init-param>
        <load-on-startup>1</load-on-startup>
    </servlet>
    <servlet-mapping>
    	<servlet-name>springmvc</servlet-name>
        <url-pattern>/</url-pattern>
    </servlet-mapping>
</web-app>
```

当 URL 模式设置为 `/` 时，即所有请求（包括那些用于静态资源）都被映射到 `dispatcher servlet`。为了正确处理静态资源，需要在 `Spring MVC` 配置文件中添加一些 `<resources/>` 元素

##### spring 配置文件

*springmvc-config.xml*

```xml
<?xml version="1.0" encoding="UTF-8"?>
<beans xmlns="http://www.springframework.org/schema/beans"
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xmlns:p="http://www.springframework.org/schema/p"
    xmlns:mvc="http://www.springframework.org/schema/mvc"
    xmlns:context="http://www.springframework.org/schema/context"
    xsi:schemaLocation="http://www.springframework.org/schema/beans
http://www.springframework.org/schema/beans/spring-beans.xsd
http://www.springframework.org/schema/mvc
http://www.springframework.org/schema/mvc/spring-mvc.xsd
http://www.springframework.org/schema/context
http://www.springframework.org/schema/context/springcontext.xsd">
<context:component-scan base-package="app18a.controller"/>
<mvc:annotation-driven/>
<mvc:resources mapping="/css/ **" location="/css/"/>
<mvc:resources mapping="/ *.html" location="/"/>
<bean id="viewResolver"       class="org.springframework.web.servlet.view.InternalResourceViewResolver">
    <property name="prefix" value="/WEB-INF/jsp/"/>
    <property name="suffix" value=".jsp"/>
</bean>
</beans>

```

如果没有 `<annotation-driver/>`，`<resources/>` 元素会阻止任意控制器被调用。若不需要使用 `resources`，则不需要 `<annotation-driver/>` 元素

#### Spring 环境抽象

Spring 的环境抽象是各种配置属性的一站式服务，它抽取了原始的属性，需要这些属性的 bean 可以从 Spring 本身中获取。Spring 环境会拉取多个属性源：JVM 系统属性，操作系统环境变量，命令行参数，Application.properties，Application.yml，将这些属性聚合在一个源中。通过这个源可以注入到 Spring 的 bean 中。

Spring Boot 自动配置的 bean 都可以通过 Spring 环境提取的属性进行配置。

##### 使用 profile 进行配置

当应用部署到不同的运行时环境中的时候，有些配置细节通常会有些差别。使用环境变量，通过这种方式来指定配置属性，而不是在 application.properties 中进行定义。但不好管理

使用 Spring profile。profile 是一种条件化的配置，在运行时，根据哪些 profile 处于激活状态，可以使用或忽略不同的 bean，配置类和配置属性

###### profile 属性

* 多个文件

  定义特定 profile 相关的属性的一种方式就是创建另外一个配置文件，其中只包含用于该 profile 对应的属性。文件名遵循：application-{profile-name}.yml 或 application-{profile-name}.properties。在该 profile 中声明配置属性。可以指定多个 profile  文件。

* 单 yml

  该方式仅适用于 YAML 配置，将特定 profile 的属性和非 profile 的属性都放到 application.yml 中，它们之间使用 --- 分割，并且使用 spring.profiles 属性来命名 profile

  ```yaml
  logging:
  	level:
  		root: WARN
  ---
  spring:
  	profiles: prod
  logging:
  	level:
  		web: DEBUG
  ```

###### 激活 profile

* 将 profile 名称的列表赋值给 spring.profiles.active 属性

  ```yaml
  spring:
  	profiles:
  		active:
  			- prod
  			- audit
  			- ha
  ```

  如果在 application.yml 中设置处于激活状态的 profile，那么这个 profile 就会变成默认的 profile

* 使用环境变量激活 profile

  ```shell
  export SPRING_PROFILES_ACTIVE=prod,audit,ha
  ```

* 以 jar 文件形式运行应用，以命令行参数形式激活 profile

  ```shell
  java -jar web.jar --spring.profiles.active=prod
  ```

###### 使用 profile 条件化地创建 bean

有时候，为不同的 profile 创建一组独特的 bean 是非常有用的。正常情况下，不管那个 profile 处于激活状态，Java 配置类中声明的所有 bean 都会被创建。假设希望某些 bean 仅在特定 profile 激活的情况下才需要创建。

在这种情况下，@profile 注解可以将某些 bean 设置为仅适用于给定的 profile

```java
@Bean
// 在 dev 或 qa profile 激活的时候都需要创建 CommandLineRunner bean
@Profile({"dev","qa"})
public CommandLineRunner dataLoader(IngredientRepository repo {}
@Bean
// 只要 prof profile 不激活就要创建 CommandLineRunner bean
@Profile("!prod")
public COmmandLineRunner dataLoade(IngredientRepository repo) {}
```

支持在带由 @Configuration 注解的类上使用 @Profile

 



