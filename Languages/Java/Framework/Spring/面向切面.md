## 面向切面

面向切面编程（`AOP`）允许把遍布应用各处的功能分离出来形成可重用的组件。面向切面编程往往被定义为促使软件系统实现关注点的分离一项技术。系统由许多不同的组件组成，每一个组件各负责一块特定功能。除了实现自身核心的功能之外，这些组件还经常承担着额外的职责。诸如日志、事务管理和安全这样的系统服务经常融入到自身具有核心业务逻辑的组件中去，这些系统服务通常被称为横切关注点，因为它们会跨越系统的多个组件

如果将这样关注点分散到多个组件中去，代码将会带来双重的复杂性

* 实现系统关注点功能的代码将会重复出现在多个组件中。这意味着如果要改变这些关注点的逻辑，必须修改各个模块中的相关实现。即使把这些关注点抽象为一个独立的模块，其他模块只是调用它的方法，但方法的调用还是会重复出现在各个模块中

* 组件会因为那些与自身核心业务无关的代码而变得混乱。一个向地址簿增加地址条目的方法应该只关注如何添加地址，而不应该关注它是不是安全的或者是否需要支持事务

  ​							*模块服务的复杂性*

![](Images/模块复杂性.png)

左边的业务对象与系统级服务结合得过于紧密。每个对象不但要知道它需要记日志、进行安全控制和参与事务，还有亲自执行这些服务

`AOP` 能够使这些服务模块化，并以声明的方式将它们应用到它们需要影响的组件中去。所造成的结果就是这些组件会具有更高的内聚性并且会更加关注自身的业务，完全不需要了解涉及系统服务所带来复杂性。`AOP` 能够确保 `POJO` 的简单性。

​				*利用AOP，系统范围内的关注点覆盖在它们所影响组件之上*

![](Images/利用AOP降低复杂.png)

可以把切面想象为覆盖在很多组件之上的一个外壳。应用是由那些实现各自业务功能的模块组成的。借助 AOP，可以使用各种功能层去包裹核心业务层。这些层以声明的方式灵活地应用到系统中，核心应用甚至根本不知道它们的存在。可以将安全、事务、日志关注点与核心业务逻辑相分离

Spring 的 `aop` 配置命名空间声明切面。首先需要把`Minstrel` 声明为一个 `bean`

```xml
<bean id="minstrel" class="com.springinaction.knights.Minstrel">
	<constructor-arg value="#{T(System).out}" />
<bean>
```

然后在 `<aop:aspect>` 元素中引用该 `bean`。为了进一步定义切面，声明（使用 `<aop:aspect>`）在 `embarkOnQuest()` 方法执行前调用 `Minstrel` 的 `singBeforeQuest()` 方法。这种方式被称为前置通知（`before advice`）。同时声明（使用 `<aop:after>`）在 `embarkOnQuest()` 方法执行后调用 `singAfterQuest()` 方法。这种方式被称为后置通知（`after advice`）

在这两种方式中，`pointcut-ref` 属性都引用了名字为 `embank` 的切入点。该切入点是在前边的 `<pointcut>` 元素中定义的，并配置 `expression` 属性来选择所应用的通知。表达式的语法采用的是 `AspectJ` 的切点表达式语言

```xml
<aop:config>
	<aop:aspect ref="minstrel">
		<aop:pointcut id="embark" expression="execution(* *.embarkOnQuest(...)) "/>
		<aop:before pointcut-ref="embark" method="singBeforeQuest"/>
		<aop:after pointcut-ref="embark" method="singAfterQuest" />
    </aop:aspect>
</aop:config>
```

此时，`Spring` 在骑士执行探险任务前后会调用 `Minstrel` 的 `singBeforeQuest()` 和 `singAfterQuest()` 方法

通过少量的 XML 配置，就可以把 `Minstrel` 声明为一个 `Spring` 切面。首先，`Minstrel` 仍然是一个 `POJO`，没有任何代码表明它要被作为一个切面使用。当按照上面那样进行配置后，在 `Spring` 的上下文中，`Minstrel` 实际上已经变成一个切面了。`Minstrel` 可以被应用到 `BraveKnight` 中，而 `BraveKnight` 不需要显式地调用它。实际上，`BraveKnight` 完全不知道 `Minstrel` 的存在

