### 存储过程

#### 定义

![](./Images/存储过程概览.png)

存储过程与视图一样，都是对 SQL 代码进行封装，可以反复利用。优点：清晰、安全，可以减少网络传输量。视图是虚拟表，通常不对底层数据表直接操作，而存储过程是程序化的 SQL，可以直接操作底层数据表。存储过程是由 SQL 语句和流控制语句构成的语句集合，可以接收参数，也可以返回输出参数给调用者，返回计算结果

#### 使用存储过程

MySQL 对存储过程的使用为调用，因此 MySQL 执行存储过程的语句为 `CALL`, `CALL` 接受存储过程的名字以及需要传递给它的任意参数。

```sql
CALL [procedure_name](@INPARAM, @OUTPARAM, @INOUTPARAM);
```

#### 创建存储过程

```sql
CREATE PROCEDURE [procedure_name]()
BEGIN
    [SQL]
END;
```

* 使用 `create procedure [proceducr_name]()` 语法创建

* 如果存储过程接受参数，将在 `()` 中列举出来。

* `BEGIN` 和 `END` 语句用来限定存储过程体，过程体是流控制语句与SQL

* `DELIMITER` 作用

   默认情况下 SQL 采用 `;` 分号作为结束符，这样当存储过程中的每一句 SQL 结束之后，采用 `;` 作为结束符，就相当于告诉 SQL 可以执行这一句。但是存储过程是一个整体，不希望 SQL逐条执行，而是采用存储过程整段执行的方式，因此需要临时定义新的 DELIMIETER。如果使用的是 Navicat 工具，在编写存储过程的时候，Navicat 会自动设置 DELIMITER 为其他符号

* 存储过程的 3 种参数类型

  IN 参数类型，不会返回，向存储过程传入参数，存储过程中修改该参数的值，不能被返回；

  OUT 参数类型，会返回，把存储过程计算的结果放到该参数中，调用者可以得到返回值

  INOUT 会返回，IN 和 OUT 的结合，即用于存储过程的传入参数，同时又可以把计算结果放到参数中，调用者可以得到返回值

#### 流控制语句

  * `BEGIN...END`

	BEGIN...END 中间包含了多个语句，每个语句都以 `;` 分号为结束符

  * `DECLARE`

    声明变量，用于 BEGIN...END 语句中间，需要在其他语句使用之前声明

  * `SET`

	赋值语句，用于对变量进行赋值

  * `SELECT...INTO`

    把从数据表中查询的结果存放到变量中，即为变量赋值

  * `IF...THEN...ENDIF`

    条件判断语句，可以在 `IF...THEN..ENDIF` 中使用 `ELSE` 和 `ELSEIF` 来进行条件判断

  * `CASE`

    CASE 语句同于多条件的分支判断，ELSE 为所有条件都不满足时

	```sql
	CASE
		WHEN expression1 
			THEN
		WHEN expression2 
			THEN
		ELSE
		    THEN
	END
	```

  * `LOOP`、`LEAVE`、`ITERATE`

     LOOP 是循环语句，使用 LEAVE 可以跳出循环，使用 ITERATE 则可以进入下一次循环

  * `REPEAT...UBTIL...END REPEAT`

     循环语句，首先会执行一次循环，然后在 UNTIL 中进行表达式判断，如果满足条件就进行循环，不满足条件就退出循环

  * `WHILE...DO...END WHILE`

	循环语句，和 REPEAT 循环不同的是，这个语句需要先进行条件判断，如果满足条件就进行循环，不满足条件就退出循环

#### 删除存储过程

```sql
drop procedure if exists [procrdure_name];
```


#### 使用参数

* 一般，存储过程并不显示结果，而是把结果返回给指定的变量

* 每个参数必须具有指定的类型。关键字 `OUT` 指出相应的参数用来从存储过程传出一个值（返回给调用者）。

* MySQL 支持 IN （传递给存储过程），OUT（从存储过程传出），INOUT（对存储过程传入和传出）类型的参数，存储过程的代码位于 BEGIN 和 END 语句内

* 显示检索出来的变量 `select @out_value_name`

  ```mysql
  CREATE PROCEDURE productpricing(
  	OUT pl DECIMAL(8,2),
  	OUT ph DECIMAL(8,2),
  	OUT pa DECIMAL(8,2)
  )
  BEGIN
  	SELECT Min(prod_price) INTO pl FROM products;
  	SELECT Max(prod_price) INTO ph FROM products;
  	SELECT Avg(prod_price) INTO pa FROM products;
  END;
  ```

* 存储过程的参数允许的数据类型与表中使用的数据类型相同

* 记录集不是允许的类型，因此，不能通过一个参数返回多个行和列，所以上面例子要使用3个参数

  ```mysql
  CREATE PROCEDURE ordertotal(
  	IN onumber INT,
  	OUT ototal DECIMAL(8,2)
  )
  BEGIN
  	SELECT Sum(item_price * quantity)
  	FROM orderitems
  	WHERE order_num = onumber
  	INTO ototal;
  END;
  ```

* 调用 `CALL ordertotal(2005, @total)`, 显示 `SELECT @total`

 #### 查看存储过程

* 显示 create 语句 `show create procedure procedure_name`

* 显示存储过程列表 `show procedure status`

  
#### 存储过程适用场景

##### 存储过程优点

* 存储过程可以一次编译多次使用。存储过程只在创造时进行编译，之后的使用都不需要重新编译，这就提升了 SQL 的执行效率

* 设定存储过程的时候可以设置对用户的使用权限，安全性较强

* 可以减少网络传输量

##### 存储过程缺点

* 可移植性差，不能跨数据库移植

* 调试较困难，开发维护难度大

* 不能进行版本控制，数据表索引发生了变化，可能会导致存储过程失效

* 不适合高并发场景