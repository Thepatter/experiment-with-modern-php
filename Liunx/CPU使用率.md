## CPU 使用率

### CPU 使用率

Linux 作为一个多任务操作系统，将每个 CPU 的时间划分为很短的时间片，再通过调度器轮流分配给各个任务使用，因此造成多任务同时运行的错觉。为了维护 CPU 时间，Linux 通过事先定义的节拍率（内核表示为 HZ），触发时间中断，并使用全局变量 `Jiffies` 记录了开机以来的节拍数。每发生一次时间中断，`Jiffies` 的值就加 1

节拍率 HZ 是内核的可配选项，可以设置为 100，250，1000 等。不同的系统可能设置不同数值，可以通过查询 `/boot/config` 内核选项来查看它的配置值。

```shell
# 查看系统节拍率
grep 'CONFIG_HZ=' /boot/config-$(uname -r)
```

因为节拍率是内核选项，所以用户空间程序并不能直接访问。为了方便用户空间程序，内核还提供了一个用户空间节拍率 `USER_HZ`，它总是固定 100，即使 1/100 秒。这样，用户空间程序并不需要关心内核中 HZ 被设置成多了，因为它看到的总是固定值 USER_HZ

Linux 通过 `/proc` 虚拟文件系统，向用户空间提供了系统内部状态的信息，而 `/proc/stat` 提供的就是系统的 CPU 和任务统计信息。

```shell
# 查看 CPU 时间
cat /proc/stat | grep ^cpu
```

这里的输出结果是一个表格。第一列表示的是 CPU 编号，如 `cpu0`，`cpu1`，而第一行没有编号的 cpu，表示的是所有 CPU 的累加。其他列则表示不同场景下 CPU 的累加节拍数，它的单位是 USER_HZ，也就是 10 ms (1/100 秒)，即不同场景下的 CPU 时间

