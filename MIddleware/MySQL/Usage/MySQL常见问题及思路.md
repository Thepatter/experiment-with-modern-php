### 常见问题

#### InnoDB 文件的损坏与恢复

##### 误删除恢复

如果已经开启了 Binlog，可以使用回滚日志工具 `mysqlbinlog` 或 `binlog2sql` 

如果没有做全量备份，也没有开启 Binlog，可以通过 `.ibd` 文件进行数据恢复，采用独立表空间的方式可以很方便地对数据库进行迁移和分析。如果误删除某个数据表或某些数据行，也可以采用第三方工具找回数据

* Persona Data Recovery Tool for InnoDB

  使用 Delete 删除时时逻辑删除，在保存数据行的时候还有个删除标记位，对应的是页结构中的 `delete_mask` 属性，该属性为 1 时候标记了记录已经被逻辑删除，不过当有新的记录插入的时候，被删除的行记录可能会被覆盖掉。当发生了 DELETE 误删除的时候，一定要第一时间停止对误删除的表进行更新和写入，及时将 `.ibd` 文件拷贝出来进行修复

##### .ibd 文件发生损坏修复

没有备份，没有 binlog。InnoDB 是有自动恢复机制的，如果发生了意外，InnoDB 可以在读取数据表时自动修复错误。

如果 `.ibd` 文件损坏了，会导致数据库无法正常读取数据表，这时需要人工修复。对应参数 `innodb_force_recovery`。

```mysql
show variables like 'innodb_force_recovery'
```

默认为 0，即不进行强制恢复，如果遇到错误，如 `ibd` 文件中的数据页发生损坏，则无法读取数据。会将错误日志记录下来。`innodb_force_revoery` 参数一共有 7 种状态 `0 ~ 6` ，分别代表不同的强制恢复措施，当需要强制恢复的时候，当需要强制恢复的时候，可以将 `innodb_force_recovery` 设置为 1，表示即使发现了损坏页也可以继续让服务运行。一般来说不需要将参数设置到 4 或以上，这可能对数据文件造成永久破坏。大于 0 时，对 `InnoDB` 进行了写保护，只能进行有限制的 SELECT，无法进行 where 过滤和 order by 排序。修复流程大致：

* 使用 innodb_force_recovery 启动服务器

  设置为 1，启动数据库，如果不能正常读取，调大参数直到能读取为止

* 备份数据表

  在备份数据之前，需要准备一个新的数据表，需要使用 MyISAM 引擎，InnoDB 引擎已经写保护了，无法将数据备份出来。然后将损坏的 InnoDB 数据表备份到新的 MyISAM 数据表中

* 删除旧表，改名新表

  删掉原有损坏的 InnoDB 数据表，然后将新表进行改名

* 关闭 innodb_force_recovery，重启数据库

  innodb_force_recovery 大于 1 时会有很多限制，需要将该功能关闭，然后重启数据库，并且将数据表的 MyISAM 引擎更新为 InnoDB 引擎

