## 利用消息队列及内存数据库提升任务大厅任务列表及领取任务性能

### 软件环境需求

* 内存数据库：redis
* 消息队列：rabbitmq：利用其消息推送及消息确认机制（确认从队列删除），消息拒绝（重新入队发送另外worker），多 worker 提升并发性能

### 接口逻辑

#### 登录

将登录信息 token 存放在 redis，数据结构为 key-value 键值对，key 为 token 登录标识符，value 为序列化字符串包含（用户信息，已做过的任务即不能在做的任务）。

登录校验成功后，返回 token，异步将 token 推送到 rabbitmq 消息队列，订阅该队列，获取该用户信息，查询该用户任务并更新内存数据库

*登录前端流程图*

```flow
st=>start: Start
e=>end: End
接收用户名和密码=>operation: 接收用户名和密码
使用用户名查询数据库=>operation: 使用用户名查询数据库
查询数据库=>condition: 查询数据库
登录成功=>operation: 生成token
存储到内存数据库=>operation: 存储到redis(key-value)
发布到队列=>operation: 发布到rabbimtmq队列
成功响应=>operation: 响应token
登录失败=>inputoutput: 响应失败
st->接收用户名和密码->使用用户名查询数据库->查询数据库
查询数据库(yes)->登录成功->存储到内存数据库->发布到队列->成功响应->e
查询数据库(no)->登录失败->e
```

后端新开子进程来消费该队列，查询用户已领取任务并写入redis

*登录后端流程图*

```sequence
Rabbit->Client: 推送消息
Note right of Client: 查询数据库任务信息并更新用户token对应value
Client->Rabbit: 消息确认
```

#### 发布任务

发布任务后入库后写入redis，查询任务列表时查询redis

```flow
st=>start: Start
e=>end: End
获取任务=>operation: 获取任务信息
任务入库=>operation: 任务信息写入数据库
任务缓存=>operation: 任务信息写入redis
st->获取任务->任务入库->任务缓存->e
```

####  任务列表

直接查询缓存redis

#### 领取任务

```flow
st=>start: Start
e=>end: End
接收用户请求=>operation: 接收用户请求
判断是否能领取该任务=>condition: 根据缓存判断是否能接该任务?
更新缓存信息=>condition: 独占更新redis缓存？
成功响应=>operation: 响应任务信息
不能接该任务=>inputoutput: 提示对应不能领取该任务原因
更新缓存失败=>inputoutput: 提示稍后再试
更新缓存成功=>inputoutput: 发布到rabbitmq队列
st->接收用户请求->判断是否能领取该任务(yes)->更新缓存信息(yes)->更新缓存成功->成功响应->e
st->接收用户请求->判断是否能领取该任务(no)->不能接该任务->e
st->接收用户请求->判断是否能领取该任务(yes)->更新缓存信息(no)->更新缓存失败->e
```

*后端逻辑*

```sequence
Rabbit->Client: 推送用户任务到队列
Client->MySql: 写入 mysql 落盘
MySql->Client: 成功
Client->Rabbit: 消息确认
MySql-->Client: 失败
Client-->Rabbit: 消息拒绝
```







