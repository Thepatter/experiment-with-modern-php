### 错误处理

#### 错误处理

当 UNIX 系统函数出错时，通常会返回一个负值，而且整型变量 errno 通常被设置为具有特定信息的值。有些函数对于出错则使用另一种约定而不是返回值：大多数返回对象指针的函数，在出错时会返回一个 null 指针

文件 `<errno.h>` 中定义了 `errno` 以及可以赋予它的各种常量。这些常量以字符 E 开头。POSIX 和 ISO C 将 errno 定义为一个符号，它扩展成为一个可修改的整形左值，可以是一个包含出错编号的整数，也可以是一个返回出错编号指针的函数。以前使用的定义是：在支持线程的环境中，多个线程共享进程地址空间，每个线程都有属于它自己的局部 errno 以避免一个线程干扰另一个线程

```c
// linux 多线程存取 errno
extern int *__errno_location(void);
#define errno (*__errno_location())
```

对于 errno，如果没有出错，其值不会被例程清除，因此，仅当函数的返回值指明出错时，才检验其值；任何函数都不会将 errno 值设为 0，而且 `<errno.h>` 中定义的所有常量都不为 0 

```c
// c 标准错误函数
#include <string.h>
char *strerror(int errnum); // 返回指向消息字符串的指针
#include <stdio.h>
void perror(const char *msg); // 基于 errno 的当前值，在标准错误上产生一条出错消息
```

#### 出错恢复

可将 `<errno.h>` 中定义的各种出错分成两类：致命性的和非致命性的。对于致命性的错误，无法执行恢复动作。最多只能打印出错消息或写入日志，然后退出。对于非致命性的出错，有时可以较妥善地进行处理。大多数非致命性错误都是暂时的

与资源相关的非致命性出错包括：`EAGAIN`、`ENFILE`、`ENOBUFS`、`ENOLCK`、`ENOSPC`、`EWOULDBLOCK`，有时 `ENOMEM` 也是非致命错误，当 `EBUSY` 指明共享资源正在使用时，也可以将其作为非致命错误。当 `EINTR` 中断一个慢速系统调用时，可将它作为非致命性出错处理

