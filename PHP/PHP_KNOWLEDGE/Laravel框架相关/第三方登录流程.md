## 第三方登录流程

**微信登录流程**

### 客户端请求微信获取微信 code

```
https://open.weixin.qq.com/connect/oauth2/authorize?appid=wx4f28dbd2cb5e557a&redirect_uri=http://larabbs.test&response_type=code&scope=snsapi_userinfo&state=STATE#wechat_redirect
```

### 服务器根据 code 获取 access_token 和 openid

```
https://api.weixin.qq.com/sns/oauth2/access_token?appid=wx4f28dbd2cb5e557a&secret=eae6910f63d4510a19801abce690cf93&code=00103Ro20YoKoC1jEFn20hYIo2003Ror&grant_type=authorization_code
```

### 服务器根据 access_token 和 openid 获取用户信息

```
https://api.weixin.qq.com/sns/userinfo?access_token=6_lBcMj3CCWb0eURuAJ0zlED5KkXeRa8JJNUKRFCCTsYDbqkpB6m7oujrIAHkupA_5rs25QBRIs0MO00IEQjF3XA&openid=oPib2v-3tdfWR8IXemQ7Gm_4MiMI&lang=zh_CN
```

### 第三方微信登录流程:

1.客户端提交微信 `code` 到服务器

2.服务器请求微信数据库获取 `access_token`

3.根据 `access_token` 获取用户信息

4.根据 `openid` 或者 `unionid` 查找用户,未找到就创建

#### 客户端请求

![](C:\Users\76073\Pictures\Saved Pictures\第三方微信登录客户端请求.png)

### ### laravel 应用

### 安装 

`composer require socialiteproviders/weixin`

### 设置 `EventServiceProvider`

`app/Providers/EventServiceProvider.php`

```php
protected $listen = [
    \SocialiteProviders\Manager\SocialiteWasCalled::class => [
        // add your listeners (aka providers) here
        'SocialiteProviders\Weixin\WeixinExtendSocialite@handle'
    ],
];
```

### 服务端代码

路由

```php
$api->version('v1', [
    'namespace' => 'App\Http\Controllers\Api',
], function($api) {

    $api->group([
        'middleware' => 'api.throttle',
        'limit' => config('api.rate_limits.sign.limit'),
        'expires' => config('api.rate_limits.sign.expires'),
    ], function($api) {
        // 短信验证码
        $api->post('verificationCodes', 'VerificationCodesController@store')
            ->name('api.verificationCodes.store');
        // 用户注册
        $api->post('users', 'UsersController@store')
            ->name('api.users.store');
        // 图片验证码
        $api->post('captchas', 'CaptchasController@store')
            ->name('api.captchas.store');
        // 第三方登录
        $api->post('socials/{social_type}/authorizations', 'AuthorizationsController@socialStore')
            ->name('api.socials.authorizations.store');
    });
});
```

**SocialAuthorizationRequest.php**

```php
<?php

namespace App\Http\Requests\Api;

use Dingo\Api\Http\FormRequest;

class SocialAuthorizationRequest extends FormRequest
{
    /**
     * Determine if the user is authorized to make this request.
     *
     * @return bool
     */
    public function authorize()
    {
        return true;
    }

    /**
     * Get the validation rules that apply to the request.
     *
     * @return array
     */
    public function rules()
    {
        // 验证规则
        $rules = [
            // code 或者 access_token 两者一个存在即可
            'code' => 'required_without:access_token|string',
            'access_token' => 'required_without:code|string',
        ];

        // 如果 URL 变量为 'weixin' 且 code 不存在,则要传参 openid
        if ($this->social_type == 'weixin' && !$this->code) {
            $rules['openid'] = 'required|string';
        }

        return $rules;
    }
}

```

**AuthorizationsController.php** 

```php
<?php

namespace App\Http\Controllers\Api;

// 用户数据模型
use App\Models\User;
use Illuminate\Http\Request;
// 前端表单验证
use App\Http\Requests\Api\SocialAuthorizationRequest;

class AuthorizationsController extends Controller
{
    public function socialStore($type, SocialAuthorizationRequest $request)
    {
        // 如果 url 里变量 $type 值不是 微信则返回请求错误
        if (!in_array($type, ['weixin'])) {
            return $this->response->errorBadRequest();
        }

        // 调用第三方生成微信请求驱动
        $driver = \Socialite::driver($type);

        // 根据 code 或者 access_token, openid 来请求微信服务器获取用户信息
        try {
            if ($code = $request->code) {
                // 根据 code 请求微信服务器,来获取 access_token 等信息
                $response = $driver->getAccessTokenResponse($code);
                $token = array_get($response, 'access_token');
            } else {
                $token = $request->access_token;

                if ($type == 'weixin') {
                    $driver->setOpenId($request->openid);
                }
            }
            // 获取微信服务器用户信息
            $oauthUser = $driver->userFromToken($token);
        } catch (\Exception $e) {
            return $this->response->errorUnauthorized('参数错误，未获取用户信息');
        }

        // 根据微信信息来查询数据库用户,存在即登录,不存在即创建
        switch ($type) {
            case 'weixin':
                $unionid = $oauthUser->offsetExists('unionid') ? $oauthUser->offsetGet('unionid') : null;

                if ($unionid) {
                    $user = User::where('weixin_unionid', $unionid)->first();
                } else {
                    $user = User::where('weixin_openid', $oauthUser->getId())->first();
                }

                // 没有用户，默认创建一个用户
                if (!$user) {
                    $user = User::create([
                        'name' => $oauthUser->getNickname(),
                        'avatar' => $oauthUser->getAvatar(),
                        'weixin_openid' => $oauthUser->getId(),
                        'weixin_unionid' => $unionid,
                    ]);
                }

                break;
        }

        return $this->response->array(['token' => $user->id]);
    }
}
```

