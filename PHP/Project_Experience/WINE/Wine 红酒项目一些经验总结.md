## Wine 红酒项目一些经验总结

### 余额支付权限问题。

__问题：__

订单采用余额支付的时的流程为：

用户选择余额支付-->输入密码来获取余额支付验证码-->提交验证码和密码来验证身份-->余额支付。

会分别发送三次请求。

第一次请求为：获取余额支付的验证码，接口为： `/user/getCode`

请求参数为：`mobile = 18608010611`,`type = balance_pay`

服务器发送短信验证码到用户的手机上。

第二次请求为：余额支付验证，接口为：/pass/check/

请求参数为：`token(登录标识), code(短信验证码), password(用户密码)`

服务器验证 code 与 password,成功则发起支付请求。失败则返回错误码。

成功发送支付请求。但是由于接口之间无状态，如果直接绕过第二次请求的结果，直接发起成功时候的第三次请求。就可以绕过第二次请求的 code 与 password 验证。造成安全隐患。

__解决方案:__

第二次请求成功后，在服务器用户缓存中写入一个验证通过标识。发起支付的时候验证服务器缓存中是否存在这样一个标识。不存在则验证不通过。验证通过后，服务端删除这个缓存标识。如果是浏览器则用 session 
来实现余额支付两次请求的前后权限的控制.
### 支付流程梳理
支付参与角色: 支付平台(微信,支付宝,银联),买家(客户端 c 端),卖家(sever 端)
基本流程如下: 卖家通知支付平台,支付平台响应令牌给卖家,卖家将令牌给买家,卖家拿着令牌去支付平台付款,付款成功后通知商户付款成功.