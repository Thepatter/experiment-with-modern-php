## `Mysql`索引

在 `Mysql` 中，索引是在存储引擎层实现地，并没有统一地索引标准，不同存储引擎索引地工作方式不一样。即使多个存储引擎支持同一种类型地索引，其底层地实现也可能不同。

### `InnoDB`索引模型

在 `InnoDB` 中，表都是根据主键顺序以索引地形式存放地，这种存储方式的表称为索引组织表。`InnoDB` 使用了 `B+` 树索引模型，数据都是存储在 `B+` 树中的，每一个索引在 `InnoDB` 里对应一棵 `B+` 树

* 主键索引的叶子节点存的是整行数据。在 `InnoDB` 里，主键索引也被称为聚簇索引（clustered index）
* 非主键索引的叶子节点内容是主键的值。在 `InnoDB` 中，非主键索引也被称为二级索引（secondary index）

#### 主键索引和普通索引的查询区别

* `select * from T where ID=500` 只需要搜索 `ID` 这个 `B+` 树
* `select * from T where K=5` 要先搜索 `K` 索引树，得到主键值，再在主键索引树上索引一次，过程称为回表，基于非主键索引的查询需要多扫描一棵索引树，尽量使用主键查询

#### 索引维护

为了维护索引有序性，在插入新值会进行维护。如果插入位置的数据页满了，则需要申请一个新的数据页，然后挪动部分数据过去。这个过程称为页分裂。在这种情况下，性能会受影响，页分裂操作还影响数据页的利用率。原本放在一个页的数据，现在分到两个页中，整体空间利用率降低大约 50%。当相邻两个页由于删除了数据，利用率很低后，会将数据页做合并（分裂过程的逆向过程）

* 自增主键：自增主键的插入数据模式，是追加操作，不涉及到挪动其他记录，不会触发叶子节点的分裂，而用逻辑字段做主键，则往往不容易保证有序插入，这样写数据成本相对较高。由于每个非主键索引的叶子节点上都是主键的值。如果用整型做主键，则只要 4 字节，如果是长整型则是 8 字节。主键长度越小，普通索引的叶子节点就越小，普通索引占用的空间也就越小
