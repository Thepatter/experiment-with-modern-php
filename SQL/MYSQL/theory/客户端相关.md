## 客户端相关

### 关于客户端的误解

#### 如果库里面的表特别多，连接就会很慢

有些线上的库，会包含很多表。这时候，每次用客户端连接都会卡在这个界面上

![](./Images/库太多客户端连接缓慢.png)

每个客户端在和服务端建立连接的时候，需要做的事情就是 TCP 握手、用户校验、获取权限。但这几个操作，和库里面表的个数无关。但实际上，当使用默认参数连接的时候，MySQL 客户端会提供一个本地库名和表名补全的功能。为了实现这个功能，客户端在连接成功后，需要多做一些操作：

1.执行 `show databases`

2.切到 `db1` 库，执行 `show tables`

3.把这两个命令的结果用于构建一个本地的哈希表。

在这些操作中，最花时间的就是第三步在本地构建哈希表的操作。所以，当一个库中的表个数非常多的时候，这一步就会花比较长的时间。连接过程慢，其实并不是连接慢，也不是服务端慢，而是客户端慢

如果在连接命令中加上 `-A`，就可以关掉这个自动补全的功能，然后客户端就可以快速返回了。除了加 `-A` 以外，加 `--quick` 或 `-q` 参数，也可以跳过这个阶段。

MySQL 客户端发送请求后，接收服务端返回结果的方式有两种：

1.一种是本地缓存，即是在本地开一片内存，先把结果存起来。如果用 API 开发，对应的就是 `mysql_store_result` 方法

2.另一种是不缓存，读一个处理一个。如果用 API 开发，对应的就是 `mysql_use_result` 方法

MySQL 客户端默认采用第一种方式，而如果加上 `--quick` 参数，就会使用第二种不缓存的方式。采用不缓存的方式时，如果本地处理得慢，就会导致服务端发送结果被阻塞，因此会让服务端变慢。

`--quick` 对客户端的影响是：

1.跳过表名自动补全功能

2.`mysql_store_result` 需要申请本地内存来缓存查询结果，如果查询结果太大，会耗费较多的本地内存，可能会影响客户端本地机器的性能

3.是不会把执行命令记录到本地的命令历史文件