## 服务docker-compose的使用

### 关于服务

在分布式应用程序中，应用程序的不同部分称为“服务”。服务实际上只是“生产中的容器”。一项服务只运行一个映像，但它定义了映像运行的方式-它应该使用哪个端口，应该运行多个容器副本，以便服务具有所需的容量。扩展服务会更改运行该软件的容器实例的数量，从而为流程中的服务分配更多的计算资源。使用 `Docker` 平台定义，运行和扩展服务非常容易-只需编写一个 `docker-compose.yml` 文件即可

### 安装  docker-compose

windows 和 mac 在 docker-desktop 里自带，Linux 下需要安装 `apt install docker-compose`

### 配置  docker-compose.yml

#### docker-compose.yml 示例

一个 `docker-compose.yml` 文件是一个 YAML 文件，它定义了 `docker` 容器在生产中的表现

*docker-compose.yml*

```yaml
version: "3"
services:
  web:
    # 替换为需要运行的镜像库镜像
    image: username/repo:tag
    deploy:
      replicas: 5
      resources:
        limits:
          cpus: "0.1"
          memory: 50M
      restart_policy:
        condition: on-failure
    ports:
      - "4000:80"
    networks:
      - webnet
networks:
  webnet: 
```

该 `docker-compose.yml` 文件告诉 `docker` 执行以下操作：

* 拉取 `username/repo:tag` 图像
* 将该映像的 5 个实例作为一个被调用的服务 `web` 运行，限制每个实例使用，最多只占单个 `CPU` 核心时间的 10%，以及 50MB RAM
* 如果一个失败，立即重启容器
* 将主机上的端口 4000 映射到 `web` 端口 80
* `web` 服务容器通过负载均衡的网络 `webnet` 共享端口 80 。（在内部，容器本身以临时端口推送 `web` 服务的 80 端口）
* `webnet` 使用默认设置（负载均衡的覆盖网络）定义网络

将 `Compose` 文件设置为 `version:"3"`。本质上，这会使其兼容 `swarm mode`。可以使用 `docker stack deploy` 命令（仅在 `Compose` 文件版本 3.x 及更高版本上受支持）运行此文件。可以使用 `docker-compose up` 运行具有非 `_swarm_` 配置的版本 3 文件。可以将 `compose` 文件命名为任何所需内容，以使其在逻辑上具有意义。`docker-compose.yml` 仅为标准名称

### 运行新的负载均衡应用

* 首先运行命令

  ```shekk
  docker swarm init
  ```

  如果不先运行以上命令，则会报错 "this node is not a swarm manager"

* 首先为应用程序命名，在这里，它被设置为 `getstartedlab`

  ```shell
  docker stack deploy -c docker-compose.yml getstartedlab
  ```

  我们在一台机器上，单个服务栈运行了 5 个容器实例。查看服务

  ```shell
  docker service ls
  # 使用栈名称查看
  docker stack services getstartedlab
  ```

  在服务中运行单个容器成为任务。任务被赋予以数字递增的唯一 ID，最多为 `docker-compose.yml` 中的 `replicas` 中定义的数量。列出服务任务

  ```shell
  docker service ps getstartedlab_web
  ```

  列出所有容器

  ```shell
  docker container ls
  ```

  ![](Images/docker列出任务和容器.png)

### 扩展应用程序

*  修改 `docker-compose.yml` 配置，并重载

  可以通过更改 `docker-compose.yml` 的 `replicas` 的值，保存更改并重新运行 `docker stack deploy` 命令（程序名字必须与原来一样）来扩展应用程序：

  ```shell
  docker stack deploy -c docker-compose.yml getstartedlab
  ```

  `docker` 执行原地更新，无需先停止服务或容器

### 停止应用程序和群

* 关闭应用程序 `docker stack rm`

  ```shell
  docker stack rm getstartedlab
  ```

* 关闭群

  ```shell
  docker swarm leave --force
  ```

### 常用命令

```shell
# 列出所有正在运行的服务
docker stack ls                               
# 运行服务 composefile 为 compose.yml 配置文件
docker stack deploy -c <composefile> <appname>
# 列出所有服务
docker service ls
# 列出 <service> 相关的服务
docker service ps <service>
# 检查任务或容器
docker inspect <task or container>
# 列出容器 id
docker container ls -q                                      # List container IDs
# 清理应用
docker stack rm <appname>
# 关闭一个单节点 swarm 管理者
docker swarm leave --force      # Take down a single node swarm from the manager
```

