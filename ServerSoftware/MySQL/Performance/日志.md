## 日志文件

### 常规查询日志和满查询日志输出

mysql 可以灵活控制写入普通查询日志和慢查询日志的输出目标，日志条目的可能目标是日志文件或系统数据库 `mysql` 中的 `general_log` 和 `slow_log` 表，可以选择文件输出表输出或两者

#### 启动时的日志控制

`log_output` 系统变量指定日志输出目的地，设置此变量本身并不会启用日志，必须分别启用日志，如果 `log_output` 在启动时未指定，则默认日志记录目标为 `FILE`，如果在启动时指定，则其值为一个或多个逗号分隔列表包含（`TABLE`，`FILE`，`NONE`）`NONE` 如果存在优先。

##### general_log

该系统变量控制记录一般查询日志，启动时指定，1 或 0，要指定文件记录默认名称以外的其他文件名称使用 `general_log_file` 变量指定。

```shell
# 启动一般查询日志并写入日志文件和表
--log_output=TABLE,FILE --general_log
```

##### slow_query_log

慢查询日志，输出文件以 `slow_query_log_file` 变量控制

```shell
# 启用慢查询日志
--log_ouput=FILE --slow_query_log
```

#### 运行时日志控制

`log_output`，`general_log`，`slow_query_log`，`general_log_file`，`slow_query_log_file` 可以在运行时修改，支持 session 与 global

#### 日志表

默认情况下，日志表使用 CSV 引擎，以逗号分隔的值格式写入数据的存储引擎，对于有权访问 `.csv` 文件的用户，可以直接导出 `.csv` 文件。

**日志表和打开文件太多错误**：如果选择 `TABLE` 作为日志目标并且日志表使用 CSV 引擎，可能会导致日志 `.csv` 文件打开许多文件描述符，可能会导致“打开文件太多”错误，可以通过执行 `FLUSH TABLE` 或确保 `open_files_limit` 大于 `table_open_cache_instances` 

```mysql
# 更改日志表
SET @old_log_state = @@GLOBAL.general_log;
SET GLOBAL general_log = 'OFF';
ALTER TABLE mysql.general_log ENGINE = MyISAM;
SET GLOBAL general_log = @old_log_state;
# 重命名日志表
USE mysql;
DROP TABLE IF EXISTS general_log2;
CREATE TABLE general_log2 LIKE general_log;
RENAME TABLE general_log TO general_log_backup, general_log2 TO general_log;
```

`TRUNCATE TABLE` 对日志表操作有效；`CHECK_TABLE` （有效）；`LOCK_TABLES`（无效）；`INSERT、DELETE、UPDATE` 不能在日志表使用，这些操作仅在服务区内部允许；`FLUSH TABLES WITH REAL LOCK` 和 `read only` 系统变量状态对日志表没有影响，服务器始终可以写入日志表；写入日志表的条目不会写入二进制日志，不会复制到从库；刷新日志表和日志文件，分别使用 `FLUSH TABLES` 或 `FLUSH LOGS`；不允许对日志表进行分区；mysqldump 转储包括报表中重新创建这些表，以便它们不会重新加载转储文件后失踪，日志表内容不转储；

### 错误日志（error log）

错误日志文件对 MySQL 的启动、运行、关闭过程进行了记录。包含诊断信息（错误，警告，注释，它们在服务器启动关及运行期间发送，如果 mysqld 注意到需要自动检查或修复表，它将向错误日志中写入一条记录）

```mysql
# 错误日志文件
show variables like 'log_error';
```

#### 错误日志组件配置

8.0 中，错误记录使用 MySQL 组件体系结构。错误日志子系统由执行日志事件过滤和写入的组件以及配置要启用那些组件以实现所需的日志记录结果的系统变量组成。

```mysql
# 默认组件 log_filter_internal log_sink_internal
select @@GLOBAL.log_error_services;
```

该变量可以包含具有 0，1 或许多元素的列表，对于列表可以使用分号或逗号（8.0.12）分隔，但不能同时使用，组件顺序决定服务器执行顺序。日志事件首先通过内置过滤器组件 `log_filter_internal`，然后再通过内置日志记录器组件 `log_sink_internal`。记录器是日志事件目的地，记录器将日志事件处理为特定格式的日志消息，并将这些消息写入其关联的输出。分配 `log_error_services` 不包含编写组件的值将导致从该点开始不写入日志处处，最后一个组成部分应该是记录器

输出目标由 `--log-error` 选项确定它们将错误信息写入控制还是文件，如果写入文件则确定错误日志文件名。（在 widow 上，`--pid-file` 和 `--console`）；`log_error_verbosity` 和 `log_error_suppression_list` 系统变量影响日志事件

要更改用于错误日志记录的日志组件集，需要家长组件并修改 `log_error_services` 值。添加或删除日志组件受以下约束：

* 要启用日志组件，首先需要加载（除非已内置或加载），然后在 `log_error_services` 值中添加，尝试在服务器启动时命名未知组件会导致其设置为默认值，尝试在运行时加载未知组件会产生错误，且该值不变。
* 要禁用日志组件，将其从 `log_error_services` 值中删除，如果该组件是可加载的且想卸载该组件，使用 `UNINSTALL COMPONENT`，尝试卸载仍在 `log_error_services` 值中组件会产生错误

```mysql
# 使用系统日志编写器而不是默认编写器，用于加载日志组件的URN前缀为 file://component_
INSTALL COMPONENT 'file://component_log_slink_syseventlog';
SET GLOBAL log_error_services = 'log_filter_internal; log_sink_sysenvent'
```

配置在每次服务器启动时启用的日志组件：

* 如果组件是可加载的，在运行时加载，加载组件会将其注册到 `mysql.component` 系统表中，以便服务器自动加载它以用于后续启动
* `log_error_services` 在启动时设置值以包括组件名称
* 在 `my.cnf` 文件中设置该值，在下次重启时生效
* 使用 `SET PERSIST` 为正在运行的实例设置该值，并保存该值以用于随后的服务器重启，立即生效，并在随后的重启中生效

```mysql
# 安装 json 记录器
INSTALL COMPONENT 'file://component_log_sink_json';
SET PERSIST log_error_services = 'log_filter_internal; log_sink_internal; log_sink_json'
```

```ini
[mysqld]
log_error_services='log_filter_internal; log_sink_internal; log_sink_json'
```

#### 默认错误日志配置

##### Windows 上的默认错误日志



##### 类Unix上默认错误日志

##### 默认错误日志影响日志记录器

### 慢查询日志（slow  log）

慢查询日志由 SQL 语句组成，这些语句需要花费超过 `long_query_time` 时间来执行并且最少请求了 `min_examined_row_limit` 行。可以使用命令行 `mysqldumpslow` 来分析慢查询日志

#### 参数

* `slow_query_log`

  ![](../Images/Performance/slow_query_log参数.png)

  是否启用慢速查询日志，可以是 0 或 OFF 以禁用日志，1 或 ON 开启。要指定日志文件名，使用 `--slow_query_log_file = file_name`，要指定日志目标，使用 `log_output` 系统变量。如果没有为慢日志指定名称，默认为 `host_name-slow.log`，除非指定了绝对路径名以指定其他目录，否则服务器将在数据目录中创建文件。

  要在运行时禁用或启用慢查询日志或geng'g

* `long_query_time` 

  ![](../Images/Performance/long_query_time参数.png)

  如果查询所花的时间长于该值，服务器将增加 `slow_queries` 状态变量。如果启用了慢查询日志，则查询将记录到慢查询日志文件中。该值实时测量，不是 CPU 时间。在轻负载系统上低于阈值的查询可能会在重负载系统上高于阈值。最小和默认分别 0 和 10，可以将值指定为微秒的分辨率

* `log_slow_admin_statements`

  ![](../Images/Performance/log_slow_admin_statements.png)

  默认情况下，不记录管理语句，使用该变量修改，管理语句包含 `ALTER TABLE，ANALYZE TABLE，CHECK TABLE，CREATE_INDEX，DROP INDEX，OPTIMIZE TABLE，REPAIR TABLE`

* `log_queries_not_using_indexes`

  ![](../Images/Performance/log_queries_not_using_indexes参数.png)

  默认情况下，不记录未使用索引的查询，如果在启用慢查询日志的情况下启用此变量，则会记录预期将检索所有行的查询，此选项不一定意味着不使用索引（使用全索引扫描的查询使用索引，但由于索引不会限制行数而将被记录）