### MySQL Server

#### Server 架构

MySQL 是典型的 C/S 架构，而 Server 层提供各种接口供 Client 调用，但 Server 层不操作数据，操作数据由引擎层负责，Server 充当 Client 与 Engine 中间代理

##### 通用架构

*组成全貌*

![](../Images/Performance/MySQL数据库结构.png)



###### 连接与安全

每个客户端连接都会在服务区进程中拥有一个线程，这个连接的查询只会在这个单独的线程中执行，服务器会缓存线程，5.5 支持线程池模式

当客户端应用连接到 MySQL 服务器时，服务器需要对其进行认证。认证基于用户名、原始主机信息、密码，如果使用了 SSL，还可以使用 X.509 证书认证。连接成功后，服务器会继续验证该客户端是否具有某个特定查询的权限

###### 优化与执行

Server 会解析查询，并创建内部数据结构（解析树），然后对其进行优化（包括重写查询，决定表的读取顺序，以及选择合适的索引）用户可以通过特殊的关键字 **HINT** 提示优化器，影响其决策

###### 在事务中混合使用存储引擎

Server 层不管理事务，事务由下层存储引擎实现，在同一个事务中，使用多种存储引擎是不可靠的。

如果在事务中混合使用了事务型和非事务型的表，在正常提交的情况下不会有什么问题，但如果该事务需要回滚，非事务型的表上的变更就无法撤销，会导致数据库处于不一致的状态，事务的最终结果将无法确定。

在非事务型的表上执行事务相关操作，Server 通常不会发出提醒，也不会报错，只会在回滚时发出警告：某些非事务型表上的变更不能被回滚。

###### Server 层锁

支持 **LOCK TABLES** 和 **UNLOCK TABLES** 语句，这是在 Server 层实现的，和存储引擎无关，它们有自己的用途。但并不能代替事务处理。

##### Schema

在 MySQL 中，数据库等价于 Schema

#### 语句执行

##### Server 层语句执行流程

#### 性能剖析

##### 定位

###### 定位

首先要确认是单条查询的问题还是服务器的问题，如果服务器上所有的程序都突然变慢，又突然变好，每一条查询也都变慢了，那么慢查询可能不一定是原因，而是由于其他问题导致的结果。

如果服务器整体运行没有问题，只有某条查询偶尔变慢，就需要将剖析该查询语句

###### show global status

这个方法实际上就是以较高的频率如一秒一次执行 SHOW GLOBAL STATUS 命令捕获数据，问题出现时，则可以通过某些计数器（如：Threads_running，Threads_connected，Questions 和 Queries ）的尖刺或凹陷来发现。这个方法很简单，对服务器的影响也很小。

###### show processlist

通过不停地捕获 show processlist 的输出，来观察是否有大量线程处于不正常。如果 5.6 起至今查询 INFORMATION_SCHEMA 中的 PROCESSLIST 表

```shell
mysql -e 'show processlist\G' | grep State: | sort | uniq -c | sort -rn
```

##### 优化

###### 剖析查询

![](../Images/Performance/SQL性能分析.png)

###### 优化

*数据库调优*

![](../Images/Performance/数据库调优.png)

