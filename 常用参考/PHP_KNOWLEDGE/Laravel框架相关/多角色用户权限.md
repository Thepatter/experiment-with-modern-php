### 多角色用户权限

角色和权限是许多 web 应用程序的重要组成部分.角色就是用户在站点中的身份,很多时候与站点权限相关联.

在 LaraBBS 将会有以下角色,权限由低到高

游客 -- 没有登录的用户

用户 -- 登录用户

管理员 -- 社区内容管理

站长 -- 权限最高的用户角色

游客可以随便浏览页面,但是无法发布内容

用户能够发布内容,却只能管理自己的内容

管理员可以管理所有用户的内容,然而不能管理用户

站长拥有最高权限,可以管理所有内容

游客和用户只需要按照登录状态来辨别即可.管理员和站长都是登录用户,并且一个用户既可以是管理员也可以是站长.在代码中,我们使用 Role 数据模型来作为角色的表现.角色能做的动作,称为权限,使用数据模型 Permission 来表现.

权限管理扩展包

Laravel  自带了简单的用户授权方案:

Gates 和 Policies 

$this->authorize() 方法

@can 和 @cannot Blade 命令

### 使用 Laravel-permission 扩展包

1.安装 `composer require "spatie/laravel-permission:~2.7"`

生成数据库迁移文件:

`php artisan vendor:publish --provider="Spatie\Permission\PermissionServiceProvider" --tag="migrations"`

数据表各自的作用：

- roles —— 角色的模型表；
- permissions —— 权限的模型表；
- model_has_roles —— 模型与角色的关联表，用户拥有什么角色在此表中定义，一个用户能拥有多个角色；
- role_has_permissions —— 角色拥有的权限关联表，如管理员拥有查看后台的权限都是在此表定义，一个角色能拥有多个权限；
- model_has_permissions —— 模型与权限关联表，一个模型能拥有多个权限。

生成配置信息:

 `php artisan vendor:publish --provider="Spatie\Permission\PermissionServiceProvider" --tag="config"`

2. 加载 `HasRoles `在 User 中使用 `laravel-permissions` 提供的 `Trait -- HasRoles` 获得扩展包提供的权限和角色的操作方法

3. 初始化角色和权限

   允许管理员维护社区的内容,管理员跟一般用户的区别是能否管理站点内容,将这个权限定义为 `manage_contents` ,管理员和站长角色都拥有 `manage_content`权限,权限的命名规范统一只用 `_` 分割法

   管理员可以管理内容,但是不能关联用户.站长却可以,将这个权限定义为 `manage_users`

   站长可以在后台管理站点相关的设置,这个权限为站长独有`manage_settings`

   初始化角色权限相关的代码

   `php artisan make:migration seed_roles_and_permissions_data`

   ```php
   <?php

   use Illuminate\Support\Facades\Schema;
   use Illuminate\Database\Schema\Blueprint;
   use Illuminate\Database\Migrations\Migration;

   use Illuminate\Database\Eloquent\Model;
   use Spatie\Permission\Models\Role;
   use Spatie\Permission\Models\Permission;

   class SeedRolesAndPermissionsData extends Migration
   {
       public function up()
       {
           // 清除缓存
           app()['cache']->forget('spatie.permission.cache');

           // 先创建权限
           Permission::create(['name' => 'manage_contents']);
           Permission::create(['name' => 'manage_users']);
           Permission::create(['name' => 'edit_settings']);

           // 创建站长角色，并赋予权限
           $founder = Role::create(['name' => 'Founder']);
           $founder->givePermissionTo('manage_contents');
           $founder->givePermissionTo('manage_users');
           $founder->givePermissionTo('edit_settings');

           // 创建管理员角色，并赋予权限
           $maintainer = Role::create(['name' => 'Maintainer']);
           $maintainer->givePermissionTo('manage_contents');
       }

       public function down()
       {
           // 清除缓存
           app()['cache']->forget('spatie.permission.cache');

           // 清空所有数据表数据
           $tableNames = config('permission.table_names');

           Model::unguard();
           DB::table($tableNames['role_has_permissions'])->delete();
           DB::table($tableNames['model_has_roles'])->delete();
           DB::table($tableNames['model_has_permissions'])->delete();
           DB::table($tableNames['roles'])->delete();
           DB::table($tableNames['permissions'])->delete();
           Model::reguard();
       }
   }
   ```

   4. 简单用法

      新建角色,只需要提供 name 字段即可

      ```php
      use Spatie\Permission\Models\Role;
      $role = Role::create(['name' => 'Founder']);
      ```

      为角色添加权限

      ```php
      use Spatie\Permission\Models\Permission;
      Permission::create(['name' => 'manage_contents']);
      $role->givePermissionTo('manage_content');  
      ```

      赋予用户某个角色

      ```php
      // 单个角色
      $user->assignRole('Founder');
      // 多个角色
      $user->assignRole('writer', 'amdin');
      // 数组形式多个角色
      $user->assignRole(['writer', 'admin']);
      ```

      检查用户角色：

      ```php
      // 是否是站长
      $user->hasRole('Founder');
      // 是否拥有至少一个角色
      $user->hasAnyRole(Role::all());
      // 是否拥有所有角色
      $user->hasAllRoles(Role::all());
      ```

      检查权限：

      ```php
      // 检查用户是否有某个权限
      $user->can('manage_contets');
      // 检查角色是否拥有某个权限
      $role->hasPermissionTo('manage_contents');
      ```

      直接给用户添加权限：

      ```php
      // 为用户添加直接权限
      $user->givePermissionTo('manage_contents');
      // 获取所有直接权限
      $user->getDirectPermissions();
      ```

      1.内容管理权限

      拥有 `manage_contents` 权限的用户允许管理站点内所有话题和回复,使用授权策略的策略过滤器机制来实现统一授权的目的.在策略中定义一个 `before` 方法, `before` 方法会在策略中其它所有方法之前执行.这样提供了全局授权的方案.在 `before` 方法中存在三种类型的返回值

      返回 true 是直接通过授权;

      返回 false 会拒绝用户所有的授权

      返回 null 则通过其他的策略方法来决定授权通过与否

      ```php
      <?php

      namespace App\Policies;

      use Illuminate\Auth\Access\HandlesAuthorization;

      class Policy
      {
          use HandlesAuthorization;

          public function before($user, $ability)
          {
              // 如果用户拥有管理内容的权限的话，即授权通过
              if ($user->can('manage_contents')) {
                  return true;
              }
          }
      }
      ```

